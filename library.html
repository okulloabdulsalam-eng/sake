<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library - KIUMA</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="nav-menu" id="navMenu">
        <div class="nav-header">
            <span class="nav-close" id="navClose"><i class="fas fa-times"></i></span>
        </div>
        <ul class="nav-list">
            <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="about.html" class="nav-link"><i class="fas fa-info-circle"></i> About</a></li>
            <li><a href="values.html" class="nav-link"><i class="fas fa-heart"></i> Values</a></li>
            <li><a href="programs.html" class="nav-link"><i class="fas fa-book"></i> Programs</a></li>
            <li><a href="activities.html" class="nav-link"><i class="fas fa-running"></i> Activities</a></li>
            <li><a href="events.html" class="nav-link"><i class="fas fa-calendar-alt"></i> Events</a></li>
            <li><a href="leadership.html" class="nav-link"><i class="fas fa-users"></i> Leadership</a></li>
            <li><a href="contact.html" class="nav-link"><i class="fas fa-phone"></i> Contact</a></li>
            <li><a href="library.html" class="nav-link active"><i class="fas fa-book-open"></i> Library</a></li>
            <li><a href="media.html" class="nav-link"><i class="fas fa-photo-video"></i> Media</a></li>
            <li><a href="ask-question.html" class="nav-link"><i class="fas fa-question-circle"></i> Ask Question</a></li>
            <li><a href="join-programs.html" class="nav-link"><i class="fas fa-user-plus"></i> Join Programs</a></li>
            <li><a href="notifications.html" class="nav-link"><i class="fas fa-bell"></i> Notifications</a></li>
            <li><a href="pay.html" class="nav-link"><i class="fas fa-credit-card"></i> Pay</a></li>
            <li><a href="join-us.html" class="nav-link"><i class="fas fa-user-circle"></i> My Account</a></li>
        </ul>
    </nav>

    <div class="container">
        <header class="header">
            <div class="header-content">
                <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
                <div class="logo-container">
                    <img src="logo.png" alt="KIUMA Logo" class="header-logo" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='block';" onload="this.style.display='block'; if(this.nextElementSibling) this.nextElementSibling.style.display='none';">
                    <svg class="header-logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <circle cx="100" cy="100" r="95" fill="none" stroke="#4CAF50" stroke-width="4"/>
                        <path id="topArc" d="M 20,100 A 80,80 0 0,1 180,100" fill="none"/>
                        <text fill="#4CAF50" font-size="9" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="0.5">
                            <textPath href="#topArc" startOffset="50%" text-anchor="middle">KAMPALA INTERNATIONAL UNIVERSITY</textPath>
                        </text>
                        <path id="bottomArc" d="M 180,100 A 80,80 0 0,1 20,100" fill="none"/>
                        <text fill="#4CAF50" font-size="9" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="0.5">
                            <textPath href="#bottomArc" startOffset="50%" text-anchor="middle">MUSLIM ASSOCIATION</textPath>
                        </text>
                        <path d="M 50,75 L 50,115 L 58,115 L 58,105 L 63,100 L 58,95 L 58,85 Z" fill="none" stroke="#4CAF50" stroke-width="2"/>
                        <circle cx="56.5" cy="100" r="2" fill="#4CAF50"/>
                        <rect x="88" y="65" width="10" height="45" fill="none" stroke="#4CAF50" stroke-width="2"/>
                        <rect x="90" y="75" width="6" height="2" fill="#4CAF50"/>
                        <rect x="90" y="85" width="6" height="2" fill="#4CAF50"/>
                        <rect x="90" y="95" width="6" height="2" fill="#4CAF50"/>
                        <polygon points="93,60 90,65 96,65" fill="#4CAF50"/>
                        <path d="M 140,92 A 12,12 0 0,1 128,92 A 10,10 0 0,0 140,92 Z" fill="#4CAF50"/>
                        <path d="M 130,88 L 131.5,92 L 136,92 L 132.5,94.5 L 134,99 L 130,96.5 L 126,99 L 127.5,94.5 L 124,92 L 128.5,92 Z" fill="#4CAF50"/>
                        <text x="100" y="145" font-size="22" font-weight="bold" fill="#4CAF50" text-anchor="middle" font-family="Arial, sans-serif" letter-spacing="2">KIUMA</text>
                    </svg>
                </div>
                <button class="notifications-btn" id="notificationsBtn">
                    <i class="fas fa-bell"></i>
                    <span class="badge" style="display: none;">0</span>
                </button>
            </div>
        </header>

        <main class="main-content">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div>
                    <h2 class="greeting">
                        <a href="about.html">KIUMA</a>
                    </h2>
                </div>
                <a href="join-us.html" class="account-icon-btn" id="accountIconBtn">
                    <i class="fas fa-user-circle" id="accountIcon"></i>
                </a>
            </section>

            <section class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <h2 class="page-title">Library</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="adminLoginBtn" onclick="showAdminLogin()" style="padding: 10px 15px;">
                        <i class="fas fa-lock"></i> Admin Login
                    </button>
                    <button class="btn btn-primary admin-only" onclick="showAddBookModal()" style="display: none; padding: 10px 15px;">
                        <i class="fas fa-plus"></i> Add Book
                    </button>
                    <button class="btn btn-secondary admin-logout" onclick="if(typeof window.logoutAdmin==='function')window.logoutAdmin()" style="display: none; padding: 10px 15px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </section>

            <section class="page-content">
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" style="flex: 1; min-width: calc(50% - 5px); padding: 12px;" onclick="if(typeof window.filterBooks==='function')window.filterBooks('all')">All</button>
                    <button class="btn btn-outline" style="flex: 1; min-width: calc(50% - 5px); padding: 12px;" onclick="if(typeof window.filterBooks==='function')window.filterBooks('islamic')">Islamic</button>
                    <button class="btn btn-outline" style="flex: 1; min-width: calc(50% - 5px); padding: 12px;" onclick="if(typeof window.filterBooks==='function')window.filterBooks('educational')">Educational</button>
                    <button class="btn btn-outline" style="flex: 1; min-width: calc(50% - 5px); padding: 12px;" onclick="if(typeof window.filterBooks==='function')window.filterBooks('quran')">Quran</button>
                </div>

                <div class="media-grid" id="libraryGrid">
                    <!-- Default book placeholders -->
                    <div class="media-item" data-category="islamic">
                        <div style="background: linear-gradient(135deg, var(--primary-green), var(--dark-green)); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 15px;">
                            <i class="fas fa-quran" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <div style="font-size: 12px; text-align: center;">Quran & Tafsir</div>
                        </div>
                    </div>
                    <div class="media-item" data-category="islamic">
                        <div style="background: linear-gradient(135deg, #4CAF50, #388E3C); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 15px;">
                            <i class="fas fa-book" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <div style="font-size: 12px; text-align: center;">Islamic Studies</div>
                        </div>
                    </div>
                    <div class="media-item" data-category="educational">
                        <div style="background: linear-gradient(135deg, #2196F3, #1976D2); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 15px;">
                            <i class="fas fa-graduation-cap" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <div style="font-size: 12px; text-align: center;">Educational</div>
                        </div>
                    </div>
                    <div class="media-item" data-category="quran">
                        <div style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 15px;">
                            <i class="fas fa-book-open" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <div style="font-size: 12px; text-align: center;">Quran Study</div>
                        </div>
                    </div>
                </div>

                <div class="info-card" style="margin-top: 20px;">
                    <h3><i class="fas fa-info-circle"></i> About Our Library</h3>
                    <p>Browse through our collection of Islamic books, educational resources, and Quranic studies materials. All books are carefully selected to support Islamic learning and community education.</p>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="index.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="programs.html" class="nav-item"><i class="fas fa-book"></i><span>Programs</span></a>
            <a href="events.html" class="nav-item"><i class="fas fa-calendar"></i><span>Events</span></a>
            <a href="pay.html" class="nav-item"><i class="fas fa-credit-card"></i><span>Pay</span></a>
            <a href="join-us.html" class="nav-item" id="accountNavItem"><i class="fas fa-user-circle"></i><span id="accountNavText">Account</span></a>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="api-config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="script.js"></script>
    <script src="update-navigation.js"></script>
    <script>
        // Define showAddBookModal immediately so it's available for onclick handlers
        window.showAddBookModal = function() {
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (!adminStatus) {
                if (typeof window.showAdminLogin === 'function') {
                    window.showAdminLogin();
                } else {
                    alert('Please login as admin first. Click the "Admin Login" button.');
                }
                return;
            }
            const modal = document.getElementById('addBookModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.zIndex = '9999';
                console.log('Add Book modal opened');
            } else {
                console.error('Add Book modal not found');
                alert('Error: Add Book form not found. Please refresh the page.');
            }
        };

        // Check admin status on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Check admin status in background (non-blocking)
            if (typeof window.checkAdminStatus === 'function') {
                setTimeout(() => {
                    window.checkAdminStatus();
                }, 0);
            } else if (typeof checkAdminStatus === 'function') {
                setTimeout(() => {
                    checkAdminStatus();
                }, 0);
            }
            
            loadBooksFromStorage('all', true);
            
            // Refresh books in background every 30 seconds (only when page is visible)
            let refreshInterval = null;
            const startBackgroundRefresh = () => {
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(() => {
                    // Only refresh if page is visible (saves battery/data)
                    if (!document.hidden) {
                        loadBooksFromStorage('all', false); // Silent refresh
                    }
                }, 30000);
            };
            
            // Start refresh when page is visible
            startBackgroundRefresh();
            
            // Pause refresh when page is hidden, resume when visible
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    if (refreshInterval) clearInterval(refreshInterval);
                } else {
                    startBackgroundRefresh();
                }
            });
            
            // Initialize admin login modal
            const adminModal = document.getElementById('adminLoginModal');
            if (adminModal) {
                adminModal.addEventListener('click', function(e) {
                    if (e.target === adminModal) {
                        closeAdminLogin();
                    }
                });
            }
            
            // Allow Enter key to submit password
            const passwordInput = document.getElementById('adminPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        if (typeof window.verifyAdminPassword === 'function') {
                            window.verifyAdminPassword();
                        }
                    }
                });
            }

            // Close add book modal on overlay click
            const addBookModal = document.getElementById('addBookModal');
            if (addBookModal) {
                addBookModal.addEventListener('click', function(e) {
                    if (e.target === addBookModal) {
                        if (typeof window.closeAddBookModal === 'function') {
                            window.closeAddBookModal();
                        }
                    }
                });
            }
        });

        // Filter books function - globally accessible
        window.filterBooks = function(category) {
            const filterButtons = document.querySelectorAll('.page-content > div:first-child button');
            
            // Update button styles based on selected filter
            filterButtons.forEach(btn => {
                const btnText = btn.textContent.trim().toLowerCase();
                const isActive = (category === 'all' && btnText === 'all') ||
                                (category === 'islamic' && btnText === 'islamic') ||
                                (category === 'educational' && btnText === 'educational') ||
                                (category === 'quran' && btnText === 'quran');
                
                if (isActive) {
                    btn.className = 'btn btn-primary';
                    btn.style.flex = '1';
                    btn.style.minWidth = 'calc(50% - 5px)';
                    btn.style.padding = '12px';
                } else {
                    btn.className = 'btn btn-outline';
                    btn.style.flex = '1';
                    btn.style.minWidth = 'calc(50% - 5px)';
                    btn.style.padding = '12px';
                }
            });
            
            // Instant client-side filtering (no reload)
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            displayBooks(cachedBooks, category, adminStatus);
        };

        window.closeAddBookModal = function() {
            const modal = document.getElementById('addBookModal');
            if (modal) {
                modal.style.display = 'none';
            }
            const form = document.getElementById('addBookForm');
            if (form) {
                form.reset();
            }
            // Clear preview
            const coverPreview = document.getElementById('coverPreview');
            const previewImage = document.getElementById('previewCoverImage');
            if (coverPreview) coverPreview.style.display = 'none';
            if (previewImage) previewImage.style.display = 'none';
        };

        window.handleBookCoverSelect = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const coverPreview = document.getElementById('coverPreview');
            const previewImage = document.getElementById('previewCoverImage');

            // Hide preview first
            if (previewImage) previewImage.style.display = 'none';
            if (coverPreview) coverPreview.style.display = 'none';

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (previewImage) {
                        previewImage.src = e.target.result;
                        previewImage.style.display = 'block';
                    }
                    if (coverPreview) coverPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };


        window.addBook = function(e) {
            if (e) {
                e.preventDefault();
            }
            
            // Check admin login status
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (!adminStatus) {
                alert('You must be logged in as admin to add books.');
                if (typeof window.showAdminLogin === 'function') {
                    window.showAdminLogin();
                }
                return false;
            }

            const titleInput = document.getElementById('bookTitle');
            const authorInput = document.getElementById('bookAuthor');
            const isbnInput = document.getElementById('bookISBN');
            const categoryInput = document.getElementById('bookCategory');
            const descriptionInput = document.getElementById('bookDescription');
            const coverInput = document.getElementById('bookCover');
            const coverUrlInput = document.getElementById('bookCoverUrl');
            
            const title = titleInput ? titleInput.value.trim() : '';
            const author = authorInput ? authorInput.value.trim() : '';
            const isbn = isbnInput ? isbnInput.value.trim() : '';
            const category = categoryInput ? categoryInput.value : '';
            const description = descriptionInput ? descriptionInput.value.trim() : '';
            const coverUrl = coverUrlInput ? coverUrlInput.value.trim() : '';
            
            // Input validation
            if (!title || !author || !category) {
                alert('Please fill in title, author, and category.');
                return false;
            }
            
            // Length validation
            if (title.length > 200) {
                alert('Title must be 200 characters or less.');
                return false;
            }
            
            if (author.length > 100) {
                alert('Author name must be 100 characters or less.');
                return false;
            }
            
            if (description.length > 2000) {
                alert('Description must be 2000 characters or less.');
                return false;
            }
            
            if (isbn.length > 20) {
                alert('ISBN must be 20 characters or less.');
                return false;
            }
            
            // Validate book file if provided
            if (bookFileInput && bookFileInput.files && bookFileInput.files[0]) {
                const validation = validateBookFile(bookFileInput.files[0]);
                if (!validation.valid) {
                    alert(validation.error);
                    return false;
                }
            }
            
            // Validate cover URL if provided
            if (coverUrl && !coverUrl.startsWith('http://') && !coverUrl.startsWith('https://') && !coverUrl.startsWith('data:')) {
                alert('Cover image URL must be a valid HTTP/HTTPS URL or data URL.');
                return false;
            }

            // Create FormData for upload
            const formData = new FormData();
            formData.append('title', title);
            formData.append('author', author);
            formData.append('isbn', isbn);
            formData.append('category', category);
            formData.append('description', description);
            formData.append('coverImageUrl', coverUrl);
            
            // Add book file if provided
            const bookFileInput = document.getElementById('bookFile');
            if (bookFileInput && bookFileInput.files && bookFileInput.files[0]) {
                formData.append('bookFile', bookFileInput.files[0]);
            }

            // Show loading
            const submitBtn = document.querySelector('#addBookForm button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            const isStaticHosting = window.location.hostname.includes('github.io') || 
                                   window.location.hostname.includes('netlify.app') ||
                                   window.location.hostname.includes('vercel.app');
            
            let saved = false;
            
            // Try to save to database if not static hosting
            if (!isStaticHosting) {
                try {
                    const response = await fetch(API_BASE_URL + '/upload_book.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            saved = true;
                            console.log('Book saved to database');
                        }
                    }
                } catch (error) {
                    console.warn('Database save failed:', error);
                }
            }
            
            // Also save to Supabase (with timeout to prevent hanging)
            try {
                const supabase = getSupabaseClient();
                if (supabase) {
                    const bookData = {
                        title: title,
                        author: author,
                        isbn: isbn || null,
                        category: category,
                        description: description || null,
                        cover_image_url: coverUrl || null,
                        drive_file_id: null, // Will be set after file upload if needed
                        created_at: new Date().toISOString()
                    };
                    
                    const supabasePromise = supabase
                        .from('books')
                        .insert([bookData])
                        .select();
                    
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Supabase timeout')), 10000)
                    );
                    
                    const { data: insertData, error: insertError } = await Promise.race([
                        supabasePromise.then(result => ({ data: result.data, error: result.error })),
                        timeoutPromise.then(() => ({ data: null, error: new Error('Supabase timeout') }))
                    ]);
                    
                    if (!insertError && insertData) {
                        console.log('Book saved to Supabase');
                        saved = true;
                        
                        // If book file was uploaded, handle it separately
                        if (bookFileInput && bookFileInput.files && bookFileInput.files[0]) {
                            // File upload would go here if needed
                            // For now, just save the metadata
                        }
                    }
                }
            } catch (error) {
                console.warn('Supabase save failed:', error);
                // Continue even if Supabase fails
            }
            
            // If neither saved, at least show success (for GitHub Pages)
            if (!saved && isStaticHosting) {
                saved = true; // Allow it on static hosting
            }
            
            if (saved) {
                // Add to cache immediately (optimistic update)
                const newBook = {
                    id: Date.now().toString(),
                    title: title,
                    author: author,
                    isbn: isbn,
                    category: category,
                    description: description,
                    cover_image_url: coverUrl,
                    drive_file_id: null,
                    supabaseId: null
                };
                cachedBooks.unshift(newBook);
                const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
                displayBooks(cachedBooks, 'all', adminStatus);
                
                // Save to localStorage
                try {
                    localStorage.setItem('cachedBooks', JSON.stringify(cachedBooks));
                } catch (e) {
                    console.log('Cache save failed:', e);
                }
                
                alert('Book added successfully!');
                window.closeAddBookModal();
                
                // Refresh in background to get real ID
                setTimeout(() => {
                    loadBooksFromStorage('all', false);
                }, 500);
            } else {
                alert('Error: Failed to save book. Please try again.');
            }
            
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        };

        // Helper function to create and add book item
        function createBookItem(title, author, isbn, category, description, coverImageUrl, libraryData) {
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            const bookItem = {
                id: Date.now().toString(),
                title: title,
                author: author,
                isbn: isbn,
                category: category,
                description: description,
                coverImage: coverImageUrl || '',
                date: new Date().toISOString()
            };

            libraryData.unshift(bookItem); // Add to beginning
            
            // Try to save to localStorage with error handling
            try {
                const dataString = JSON.stringify(libraryData);
                localStorage.setItem('libraryData', dataString);
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    // Remove the item we just added since we can't save it
                    libraryData.shift();
                    
                    // Try to free up space by removing oldest items
                    if (libraryData.length > 0) {
                        const removed = libraryData.pop(); // Remove oldest
                        try {
                            localStorage.setItem('libraryData', JSON.stringify(libraryData));
                            alert('Storage is full! The oldest book was removed to make space. Please try adding your book again, or delete more items manually.');
                        } catch (e2) {
                            // Still can't save, need to remove more or clear
                            alert('Storage is completely full! Please delete some books manually or clear your browser storage, then try again.');
                        }
                    } else {
                        alert('Storage is full and cannot be cleared automatically. Please clear your browser storage or delete books manually.');
                    }
                    return false;
                } else {
                    alert('Error saving book: ' + e.message);
                    return false;
                }
            }

            // Create and display book item
            const libraryGrid = document.getElementById('libraryGrid');
            const newBookItem = document.createElement('div');
            newBookItem.className = 'media-item';
            newBookItem.dataset.category = category;
            newBookItem.dataset.id = bookItem.id;

            const safeTitle = title.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const safeAuthor = author.replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const safeDescription = (description || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
            const safeCover = coverImageUrl ? coverImageUrl.replace(/'/g, "&#39;") : '';
            
            // Default cover if no image provided
            const coverDisplay = safeCover ? 
                `<img src="${safeCover}" alt="${safeTitle}" style="width: 100%; height: 200px; object-fit: cover;">` :
                `<div style="width: 100%; height: 200px; background: linear-gradient(135deg, var(--primary-green), var(--dark-green)); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;"><i class="fas fa-book"></i></div>`;
            
            newBookItem.innerHTML = `
                <div style="width: 100%; height: 100%; position: relative; border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
                    ${coverDisplay}
                    <div style="padding: 12px; flex: 1; display: flex; flex-direction: column;">
                        <h4 style="margin: 0 0 5px 0; font-size: 14px; font-weight: 600; color: var(--dark-gray); line-height: 1.3;">${safeTitle}</h4>
                        <p style="margin: 0 0 5px 0; font-size: 12px; color: var(--text-gray);">by ${safeAuthor}</p>
                        ${isbn ? `<p style="margin: 0 0 5px 0; font-size: 11px; color: var(--text-gray);">ISBN: ${isbn}</p>` : ''}
                        ${safeDescription ? `<p style="margin: 5px 0 0 0; font-size: 11px; color: var(--text-gray); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${safeDescription}</p>` : ''}
                    </div>
                    ${adminStatus ? `<button onclick="deleteBook('${bookItem.id}')" style="position: absolute; top: 8px; right: 8px; background: #f44336; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 14px; z-index: 10;">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
                </div>
            `;

            // Insert at the beginning
            if (libraryGrid) {
                libraryGrid.insertBefore(newBookItem, libraryGrid.firstChild);
                window.closeAddBookModal();
                alert('Book added successfully!');
                // Reload books to ensure consistency
                setTimeout(function() {
                    loadBooksFromStorage();
                }, 100);
            } else {
                alert('Error: Could not find library grid container.');
            }
        }

        // Delete book function - admin only
        window.deleteBook = function(bookId) {
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (!adminStatus) {
                alert('You must be logged in as admin to delete books.');
                return;
            }
            
            // Sanitize bookId to prevent XSS
            const safeBookId = sanitizeHTML(bookId.toString());
            
            // Use custom confirm dialog (mobile-friendly)
            if (!confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
                return;
            }
            
            const adminPassword = prompt('Enter admin password to confirm deletion:');
            if (!adminPassword || adminPassword !== 'kiuma2025') {
                if (adminPassword) {
                    alert('Incorrect password.');
                }
                return;
            }
            
            const isStaticHosting = window.location.hostname.includes('github.io') || 
                                   window.location.hostname.includes('netlify.app') ||
                                   window.location.hostname.includes('vercel.app');
            
            let deleted = false;
            
            // Try to delete from database if not static hosting
            if (!isStaticHosting) {
                const formData = new FormData();
                formData.append('id', safeBookId);
                formData.append('password', adminPassword);
                
                fetch(API_BASE_URL + '/delete_book.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        deleted = true;
                        console.log('Book deleted from database');
                    }
                })
                .catch(error => {
                    console.warn('Database delete failed:', error);
                });
            }
            
            // Also delete from Supabase
            (async () => {
                try {
                    const supabase = getSupabaseClient();
                    if (supabase) {
                        // Try to find book by ID (could be numeric or string)
                        let deleteQuery = supabase
                            .from('books')
                            .delete()
                            .eq('id', safeBookId);
                        
                        const supabasePromise = deleteQuery;
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Supabase timeout')), 10000)
                        );
                        
                        const { error: deleteError } = await Promise.race([
                            supabasePromise.then(result => ({ error: result.error })),
                            timeoutPromise.then(() => ({ error: new Error('Supabase timeout') }))
                        ]);
                        
                        if (!deleteError) {
                            console.log('Book deleted from Supabase');
                            deleted = true;
                        }
                    }
                } catch (error) {
                    console.warn('Supabase delete failed:', error);
                }
                
                // Optimistically remove from cache
                cachedBooks = cachedBooks.filter(book => book.id.toString() !== safeBookId && book.supabaseId?.toString() !== safeBookId);
                const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
                displayBooks(cachedBooks, 'all', adminStatus);
                
                // Save to localStorage
                try {
                    localStorage.setItem('cachedBooks', JSON.stringify(cachedBooks));
                } catch (e) {
                    console.log('Cache save failed:', e);
                }
                
                if (deleted || isStaticHosting) {
                    alert('Book deleted successfully!');
                    // Refresh in background
                    setTimeout(() => {
                        loadBooksFromStorage('all', false);
                    }, 500);
                } else {
                    alert('Error: Failed to delete book. Please try again.');
                }
            })();
        };

        // Helper function to clear old books (keeps last N items)
        window.clearOldBooks = function(keepCount = 10) {
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (!adminStatus) {
                alert('You must be logged in as admin to clear books.');
                return;
            }
            
            if (!confirm(`This will keep only the ${keepCount} most recent books. Continue?`)) {
                return;
            }
            
            try {
                let libraryData = JSON.parse(localStorage.getItem('libraryData') || '[]');
                if (libraryData.length <= keepCount) {
                    alert('No old books to clear. You have ' + libraryData.length + ' books.');
                    return;
                }
                
                const removed = libraryData.length - keepCount;
                libraryData = libraryData.slice(0, keepCount); // Keep only the first N (most recent)
                localStorage.setItem('libraryData', JSON.stringify(libraryData));
                
                // Reload books display
                loadBooksFromStorage();
                alert(`Cleared ${removed} old books. Kept ${keepCount} most recent books.`);
            } catch (e) {
                console.error('Error clearing old books:', e);
                alert('Error clearing books. Please try again.');
            }
        };

        // Sanitize HTML to prevent XSS
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Sanitize URL to prevent XSS
        function sanitizeURL(url) {
            if (!url) return '';
            // Basic URL validation - only allow http/https/data URLs
            try {
                const urlObj = new URL(url);
                if (!['http:', 'https:', 'data:'].includes(urlObj.protocol)) {
                    return '';
                }
                return url;
            } catch (e) {
                // If URL parsing fails, return empty
                return '';
            }
        }
        
        // Get Supabase client
        let supabaseClient = null;
        function getSupabaseClient() {
            if (supabaseClient) return supabaseClient;
            if (typeof initializeSupabase === 'function') {
                supabaseClient = initializeSupabase();
            } else if (typeof supabase !== 'undefined' && window.supabaseConfig) {
                try {
                    supabaseClient = supabase.createClient(
                        window.supabaseConfig.supabaseUrl,
                        window.supabaseConfig.supabaseAnonKey
                    );
                } catch (e) {
                    console.error('Error creating Supabase client:', e);
                }
            }
            return supabaseClient;
        }
        
        // Validate file before upload
        function validateBookFile(file) {
            const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB
            const allowedTypes = ['application/pdf', 'application/epub+zip', 'application/x-mobipocket-ebook'];
            
            // Check file size
            if (file.size > MAX_FILE_SIZE) {
                return { valid: false, error: `File size (${(file.size / (1024 * 1024)).toFixed(2)}MB) exceeds maximum allowed size of 100MB.` };
            }
            
            // Check file type
            const isValidType = allowedTypes.includes(file.type) || file.name.toLowerCase().endsWith('.pdf') || file.name.toLowerCase().endsWith('.epub');
            if (!isValidType) {
                return { valid: false, error: `File type "${file.type || file.name}" is not supported. Please upload a PDF or EPUB file.` };
            }
            
            return { valid: true };
        }
        
        // Track if we've already logged API warnings (reduce console noise)
        let apiWarningLogged = false;
        let cachedBooks = []; // Cache books for instant filtering
        
        // Load books from server (with Supabase fallback)
        async function loadBooksFromStorage(category = 'all', showLoading = true) {
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            const libraryGrid = document.getElementById('libraryGrid');
            
            if (!libraryGrid) {
                console.error('Library grid not found');
                return;
            }
            
            // Try to load from localStorage cache first (instant)
            if (cachedBooks.length === 0) {
                try {
                    const cached = localStorage.getItem('cachedBooks');
                    if (cached) {
                        cachedBooks = JSON.parse(cached);
                        if (cachedBooks.length > 0) {
                            displayBooks(cachedBooks, category, adminStatus);
                            showLoading = false; // Already showing data
                        }
                    }
                } catch (e) {
                    console.log('Cache load failed:', e);
                }
            } else if (showLoading) {
                // Show cached data immediately if available
                displayBooks(cachedBooks, category, adminStatus);
                showLoading = false;
            }
            
            // Show loading state if grid is empty or only has placeholders
            if (showLoading) {
                const existingItems = Array.from(libraryGrid.querySelectorAll('.media-item[data-id]'));
                if (existingItems.length === 0) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 40px; color: #999;';
                    loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 10px;"></i><p>Loading books...</p>';
                    loadingDiv.id = 'booksLoadingDiv';
                    libraryGrid.appendChild(loadingDiv);
                } else {
                    // Clear existing items first (except default placeholders)
                    existingItems.forEach(item => item.remove());
                }
            }
            
            const isStaticHosting = window.location.hostname.includes('github.io') || 
                                   window.location.hostname.includes('netlify.app') ||
                                   window.location.hostname.includes('vercel.app');
            
            let books = [];
            
            // Try to load from API if not static hosting (with timeout)
            if (!isStaticHosting) {
                try {
                    const url = category === 'all' ? (API_BASE_URL + '/get_books.php') : (API_BASE_URL + `/get_books.php?category=${category}`);
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                    
                    const response = await fetch(url, { signal: controller.signal });
                    
                    if (response.status === 404) {
                        // Only log warning once per session to reduce console noise
                        if (!apiWarningLogged) {
                            console.log('API endpoint not available. Using Supabase fallback.');
                            apiWarningLogged = true;
                        }
                        throw new Error('API_NOT_FOUND');
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (data.success && data.books) {
                        books = data.books;
                    }
                } catch (error) {
                    // Silently continue to Supabase fallback
                    if (error.message !== 'API_NOT_FOUND' && !apiWarningLogged) {
                        console.log('API not available, using Supabase:', error.message);
                        apiWarningLogged = true;
                    }
                }
            }
            
            // Add overall loading timeout (10 seconds)
            const overallTimeout = setTimeout(() => {
                if (books.length === 0 && showLoading) {
                    const loadingDiv = document.getElementById('booksLoadingDiv') || 
                                      libraryGrid.querySelector('div[style*="grid-column: 1/-1"]');
                    if (loadingDiv && loadingDiv.querySelector('.fa-spinner')) {
                        loadingDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>Loading timed out. Please check your connection.</p>
                            <button onclick="loadBooksFromStorage('${category}', true)" class="btn btn-primary" style="margin-top: 10px; padding: 8px 16px;">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        `;
                    }
                }
            }, 10000);
            
            // Fallback to Supabase if API failed or static hosting
            if (books.length === 0) {
                try {
                    const supabase = getSupabaseClient();
                    if (supabase) {
                        let query = supabase
                            .from('books')
                            .select('*')
                            .order('created_at', { ascending: false })
                            .limit(100);
                        
                        // Filter by category if not 'all'
                        if (category !== 'all') {
                            query = query.eq('category', category);
                        }
                        
                        const supabasePromise = query;
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Supabase timeout')), 10000)
                        );
                        
                        const { data, error } = await Promise.race([
                            supabasePromise.then(result => ({ data: result.data, error: result.error })),
                            timeoutPromise.then(() => ({ data: null, error: new Error('Supabase timeout') }))
                        ]);
                        
                        if (error) {
                            throw error;
                        }
                        
                        if (data) {
                            books = data.map(book => ({
                                id: book.id?.toString() || '',
                                title: book.title || '',
                                author: book.author || '',
                                description: book.description || '',
                                category: book.category || 'other',
                                cover_image_url: book.cover_image_url || book.cover_url || '',
                                isbn: book.isbn || '',
                                drive_file_id: book.drive_file_id || book.file_url || book.file_path || '',
                                supabaseId: book.id?.toString() || ''
                            }));
                        }
                    }
                } catch (error) {
                    // Silently fail - Supabase is optional
                    if (!apiWarningLogged) {
                        console.log('Supabase not available:', error.message);
                        apiWarningLogged = true;
                    }
                }
            }
            
            // Clear overall timeout if we got books
            clearTimeout(overallTimeout);
            
            // Cache books
            cachedBooks = books;
            
            // Save to localStorage for instant load next time (with quota handling)
            try {
                localStorage.setItem('cachedBooks', JSON.stringify(cachedBooks));
            } catch (e) {
                console.log('Cache save failed:', e);
                // If quota exceeded, try to clear old cache
                if (e.name === 'QuotaExceededError') {
                    try {
                        const limitedCache = cachedBooks.slice(0, 50);
                        localStorage.setItem('cachedBooks', JSON.stringify(limitedCache));
                    } catch (e2) {
                        console.error('Error clearing cache:', e2);
                    }
                }
            }
            
            // Display books
            displayBooks(cachedBooks, category, adminStatus);
            
            // Show error if both failed and we have no books
            if (books.length === 0 && showLoading) {
                const loadingDiv = document.getElementById('booksLoadingDiv') || 
                                  libraryGrid.querySelector('div[style*="grid-column: 1/-1"]');
                if (loadingDiv) {
                    loadingDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Unable to load books. Please check your connection.</p>
                        <button onclick="loadBooksFromStorage('${category}', true)" class="btn btn-primary" style="margin-top: 10px; padding: 8px 16px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    `;
                }
            }
        }
        
        // Display books (instant, no loading)
        function displayBooks(books, category = 'all', adminStatus = false) {
            const libraryGrid = document.getElementById('libraryGrid');
            if (!libraryGrid) return;
            
            // Filter by category (client-side, instant)
            let filtered = books;
            if (category !== 'all') {
                filtered = books.filter(book => {
                    const bookCategory = book.category || 'other';
                    return bookCategory.toLowerCase() === category.toLowerCase();
                });
            }
            
            // Remove loading indicator
            const loadingDiv = document.getElementById('booksLoadingDiv') || 
                              libraryGrid.querySelector('div[style*="grid-column: 1/-1"]');
            if (loadingDiv) {
                loadingDiv.remove();
            }
            
            // Clear existing items
            const existingItems = Array.from(libraryGrid.querySelectorAll('.media-item[data-id]'));
            existingItems.forEach(item => item.remove());
            
            if (filtered.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 40px; color: #999;';
                emptyDiv.innerHTML = '<i class="fas fa-book" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></i><p>No books found' + (category !== 'all' ? ` in ${category} category` : '') + '</p>';
                libraryGrid.appendChild(emptyDiv);
                return;
            }
            
            // Render books
            filtered.forEach(book => {
                const newBookItem = document.createElement('div');
                newBookItem.className = 'media-item';
                newBookItem.dataset.category = book.category || 'other';
                newBookItem.dataset.id = book.id;
                
                // Sanitize all inputs to prevent XSS
                const safeTitle = sanitizeHTML(book.title || '');
                const safeAuthor = sanitizeHTML(book.author || '');
                const safeDescription = sanitizeHTML(book.description || '');
                const safeCover = sanitizeURL(book.cover_image_url || '');
                const safeISBN = sanitizeHTML(book.isbn || '');
                const safeId = sanitizeHTML(book.id.toString());
                
                // Use proxy download endpoint or direct Supabase URL
                let downloadLink = '';
                if (book.drive_file_id) {
                    // Try PHP endpoint first, fallback to direct URL
                    const isStaticHosting = window.location.hostname.includes('github.io') || 
                                           window.location.hostname.includes('netlify.app') ||
                                           window.location.hostname.includes('vercel.app');
                    if (!isStaticHosting) {
                        downloadLink = API_BASE_URL + '/download_book.php?id=' + safeId;
                    } else {
                        // On static hosting, use direct file URL if available
                        downloadLink = book.drive_file_id.startsWith('http') ? book.drive_file_id : '';
                    }
                }
                
                // Default cover if no image provided
                const coverDisplay = safeCover ? 
                    `<img src="${safeCover}" alt="${safeTitle}" style="width: 100%; height: 200px; object-fit: cover;">` :
                    `<div style="width: 100%; height: 200px; background: linear-gradient(135deg, var(--primary-green), var(--dark-green)); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px;"><i class="fas fa-book"></i></div>`;
                
                newBookItem.innerHTML = `
                    <div style="width: 100%; height: 100%; position: relative; border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
                        ${coverDisplay}
                        <div style="padding: 12px; flex: 1; display: flex; flex-direction: column;">
                            <h4 style="margin: 0 0 5px 0; font-size: 14px; font-weight: 600; color: var(--dark-gray); line-height: 1.3;">${safeTitle}</h4>
                            <p style="margin: 0 0 5px 0; font-size: 12px; color: var(--text-gray);">by ${safeAuthor}</p>
                            ${safeISBN ? `<p style="margin: 0 0 5px 0; font-size: 11px; color: var(--text-gray);">ISBN: ${safeISBN}</p>` : ''}
                            ${safeDescription ? `<p style="margin: 5px 0 0 0; font-size: 11px; color: var(--text-gray); line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${safeDescription}</p>` : ''}
                            ${downloadLink ? `<a href="${downloadLink}" download="${safeTitle}.pdf" style="margin-top: 10px; padding: 8px 12px; background: var(--primary-green); color: white; text-decoration: none; border-radius: 5px; text-align: center; font-size: 12px; display: inline-block;"><i class="fas fa-download"></i> Download</a>` : ''}
                        </div>
                        ${adminStatus ? `<button onclick="deleteBook('${safeId}')" style="position: absolute; top: 8px; right: 8px; background: #f44336; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-size: 14px; z-index: 10; touch-action: manipulation;" aria-label="Delete book">
                            <i class="fas fa-trash"></i>
                        </button>` : ''}
                    </div>
                `;

                libraryGrid.insertBefore(newBookItem, libraryGrid.firstChild);
            });
        }
        
        // Re-render books when admin status changes
        window.addEventListener('storage', function(e) {
            if (e.key === 'isAdminLoggedIn') {
                loadBooksFromStorage();
            }
        });
    </script>

    <!-- Admin Login Modal -->
    <div class="modal-overlay" id="adminLoginModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt"></i> Admin Login</h3>
                <button class="modal-close" onclick="closeAdminLogin()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Sign in with your account to access admin features.</p>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="adminEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="adminPassword" placeholder="Enter your password">
                    <p id="passwordError" style="color: #f44336; font-size: 14px; margin-top: 5px; display: none;">Incorrect email or password.</p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="if(typeof window.verifyAdminPassword==='function')window.verifyAdminPassword()" style="flex: 1;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <button class="btn btn-secondary" onclick="if(typeof window.closeAdminLogin==='function')window.closeAdminLogin()" style="flex: 1;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div class="modal-overlay" id="addBookModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book"></i> Add New Book</h3>
                <button class="modal-close" onclick="if(typeof window.closeAddBookModal==='function')window.closeAddBookModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addBookForm" onsubmit="event.preventDefault(); if(typeof window.addBook==='function'){window.addBook(event);} return false;" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label">Book Title *</label>
                        <input type="text" class="form-input" id="bookTitle" placeholder="Enter book title" required maxlength="200">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Author *</label>
                        <input type="text" class="form-input" id="bookAuthor" placeholder="Enter author name" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ISBN (Optional)</label>
                        <input type="text" class="form-input" id="bookISBN" placeholder="Enter ISBN number" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select class="form-input" id="bookCategory" required>
                            <option value="">Select category</option>
                            <option value="islamic">Islamic</option>
                            <option value="quran">Quran</option>
                            <option value="educational">Educational</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description <span id="descriptionCharCount" style="font-size: 12px; color: #999;">0/2000</span></label>
                        <textarea class="form-input" id="bookDescription" rows="3" placeholder="Enter book description" maxlength="2000" oninput="const count = this.value.length; const counter = document.getElementById('descriptionCharCount'); if(counter) counter.textContent = count + '/2000';"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cover Image</label>
                        <input type="file" class="form-input" id="bookCover" accept="image/*" onchange="if(typeof window.handleBookCoverSelect==='function')window.handleBookCoverSelect(event)">
                        <p style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">Upload book cover image (max 2MB)</p>
                        <div id="coverPreview" style="margin-top: 10px; display: none;">
                            <img id="previewCoverImage" src="" alt="Cover Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px; display: none; border: 2px solid var(--light-gray);">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Or Enter Cover Image URL (Optional)</label>
                        <input type="url" class="form-input" id="bookCoverUrl" placeholder="https://example.com/book-cover.jpg">
                        <p style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">Alternative: Enter a URL for the book cover image</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Book File (PDF, DOC, DOCX, EPUB, TXT) - Optional</label>
                        <input type="file" class="form-input" id="bookFile" accept=".pdf,.doc,.docx,.epub,.txt">
                        <p style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">Upload the book file to Google Drive (Max 500MB)</p>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            <i class="fas fa-plus"></i> Add Book
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="if(typeof window.closeAddBookModal==='function')window.closeAddBookModal()" style="flex: 1;">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Floating Kizumu Visit Button -->
    <div class="floating-kizumu-btn" onclick="showActivitiesModal()">
        <i class="fas fa-heart"></i>
        <span>Kizumu Visit</span>
    </div>

    <!-- Activities Modal -->
    <div class="modal-overlay" id="activitiesModal" style="display: none;">
        <div class="modal-content activities-modal">
            <div class="modal-header">
                <h3><i class="fas fa-heart"></i> Important Activities</h3>
                <button class="modal-close" onclick="closeActivitiesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="activities-modal-list">
                <div class="activity-modal-item" onclick="navigateToActivity('kizumu-visit')">
                    <div class="activity-modal-icon" style="background: #E91E63;">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>Kizumu Tahfiz Charity Visit</h4>
                        <p>Support Islamic education through charity visit</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="activity-modal-item" onclick="navigateToActivity('tuition-brothers')">
                    <div class="activity-modal-icon" style="background: var(--primary-green);">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>Tuition for Brothers</h4>
                        <p>Support brothers' education and learning</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="activity-modal-item" onclick="navigateToActivity('kisilaahe')">
                    <div class="activity-modal-icon" style="background: #9C27B0;">
                        <i class="fas fa-donate"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>Donate to Kisilaahe</h4>
                        <p>Support Kisilaahe with essential items</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="activity-modal-item" onclick="navigateToActivity('activities')">
                    <div class="activity-modal-icon" style="background: #FF9800;">
                        <i class="fas fa-running"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>View All Activities</h4>
                        <p>See all community activities and events</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

