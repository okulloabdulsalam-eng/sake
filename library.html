<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library - KIUMA</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="nav-menu" id="navMenu">
        <div class="nav-header">
            <span class="nav-close" id="navClose"><i class="fas fa-times"></i></span>
        </div>
        <ul class="nav-list">
            <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="about.html" class="nav-link"><i class="fas fa-info-circle"></i> About</a></li>
            <li><a href="values.html" class="nav-link"><i class="fas fa-heart"></i> Values</a></li>
            <li><a href="programs.html" class="nav-link"><i class="fas fa-book"></i> Programs</a></li>
            <li><a href="activities.html" class="nav-link"><i class="fas fa-running"></i> Activities</a></li>
            <li><a href="events.html" class="nav-link"><i class="fas fa-calendar-alt"></i> Events</a></li>
            <li><a href="leadership.html" class="nav-link"><i class="fas fa-users"></i> Leadership</a></li>
            <li><a href="contact.html" class="nav-link"><i class="fas fa-phone"></i> Contact</a></li>
            <li><a href="library.html" class="nav-link active"><i class="fas fa-book-open"></i> Library</a></li>
            <li><a href="media.html" class="nav-link"><i class="fas fa-photo-video"></i> Media</a></li>
            <li><a href="ask-question.html" class="nav-link"><i class="fas fa-question-circle"></i> Ask Question</a></li>
            <li><a href="join-programs.html" class="nav-link"><i class="fas fa-user-plus"></i> Join Programs</a></li>
            <li><a href="notifications.html" class="nav-link"><i class="fas fa-bell"></i> Notifications</a></li>
            <li><a href="pay.html" class="nav-link"><i class="fas fa-credit-card"></i> Pay</a></li>
            <li><a href="join-us.html" class="nav-link"><i class="fas fa-user-circle"></i> My Account</a></li>
        </ul>
    </nav>

    <div class="container">
        <header class="header">
            <div class="header-content">
                <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
                <div class="logo-container">
                    <img src="logo.png" alt="KIUMA Logo" class="header-logo" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='block';" onload="this.style.display='block'; if(this.nextElementSibling) this.nextElementSibling.style.display='none';">
                    <svg class="header-logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <circle cx="100" cy="100" r="95" fill="none" stroke="#4CAF50" stroke-width="4"/>
                        <path id="topArc" d="M 20,100 A 80,80 0 0,1 180,100" fill="none"/>
                        <text fill="#4CAF50" font-size="9" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="0.5">
                            <textPath href="#topArc" startOffset="50%" text-anchor="middle">KAMPALA INTERNATIONAL UNIVERSITY</textPath>
                        </text>
                        <path id="bottomArc" d="M 180,100 A 80,80 0 0,1 20,100" fill="none"/>
                        <text fill="#4CAF50" font-size="9" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="0.5">
                            <textPath href="#bottomArc" startOffset="50%" text-anchor="middle">MUSLIM ASSOCIATION</textPath>
                        </text>
                        <path d="M 50,75 L 50,115 L 58,115 L 58,105 L 63,100 L 58,95 L 58,85 Z" fill="none" stroke="#4CAF50" stroke-width="2"/>
                        <circle cx="56.5" cy="100" r="2" fill="#4CAF50"/>
                        <rect x="88" y="65" width="10" height="45" fill="none" stroke="#4CAF50" stroke-width="2"/>
                        <rect x="90" y="75" width="6" height="2" fill="#4CAF50"/>
                        <rect x="90" y="85" width="6" height="2" fill="#4CAF50"/>
                        <rect x="90" y="95" width="6" height="2" fill="#4CAF50"/>
                        <polygon points="93,60 90,65 96,65" fill="#4CAF50"/>
                        <path d="M 140,92 A 12,12 0 0,1 128,92 A 10,10 0 0,0 140,92 Z" fill="#4CAF50"/>
                        <path d="M 130,88 L 131.5,92 L 136,92 L 132.5,94.5 L 134,99 L 130,96.5 L 126,99 L 127.5,94.5 L 124,92 L 128.5,92 Z" fill="#4CAF50"/>
                        <text x="100" y="145" font-size="22" font-weight="bold" fill="#4CAF50" text-anchor="middle" font-family="Arial, sans-serif" letter-spacing="2">KIUMA</text>
                    </svg>
                </div>
                <button class="notifications-btn" id="notificationsBtn">
                    <i class="fas fa-bell"></i>
                    <span class="badge" style="display: none;">0</span>
                </button>
            </div>
        </header>

        <main class="main-content">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div>
                    <h2 class="greeting">
                        <a href="about.html">KIUMA</a>
                    </h2>
                </div>
                <a href="join-us.html" class="account-icon-btn" id="accountIconBtn">
                    <i class="fas fa-user-circle" id="accountIcon"></i>
                </a>
            </section>

            <section class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <h2 class="page-title">Library</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="adminLoginBtn" onclick="showAdminLogin()" style="padding: 10px 15px;">
                        <i class="fas fa-lock"></i> Admin Login
                    </button>
                    <button class="btn btn-primary admin-only" onclick="showAddBookModal()" style="display: none; padding: 10px 15px;">
                        <i class="fas fa-plus"></i> Add Book
                    </button>
                    <button class="btn btn-secondary admin-logout" onclick="if(typeof window.logoutAdmin==='function')window.logoutAdmin()" style="display: none; padding: 10px 15px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </section>

            <section class="page-content">
                <!-- Category Cards Grid -->
                <div class="category-cards-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px;">
                    <!-- All Category Card -->
                    <div class="category-card active" data-category="all" onclick="if(typeof window.filterBooks==='function')window.filterBooks('all')" style="background: linear-gradient(135deg, #4CAF50, #388E3C); border-radius: 12px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; touch-action: manipulation;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <i class="fas fa-th" style="font-size: 24px; color: white;"></i>
                            <span class="category-badge" style="background: rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="count-all">0</span>
                        </div>
                        <div style="color: white; font-size: 16px; font-weight: 600;">All</div>
                    </div>
                    
                    <!-- Quran Category Card -->
                    <div class="category-card" data-category="quran" onclick="if(typeof window.filterBooks==='function')window.filterBooks('quran')" style="background: linear-gradient(135deg, #4CAF50, #388E3C); border-radius: 12px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; touch-action: manipulation;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <i class="fas fa-quran" style="font-size: 24px; color: white;"></i>
                            <span class="category-badge" style="background: rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="count-quran">0</span>
                        </div>
                        <div style="color: white; font-size: 16px; font-weight: 600;">Quran</div>
                    </div>
                    
                    <!-- Yasaruna Category Card -->
                    <div class="category-card" data-category="yasaruna" onclick="if(typeof window.filterBooks==='function')window.filterBooks('yasaruna')" style="background: linear-gradient(135deg, #2196F3, #1976D2); border-radius: 12px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; touch-action: manipulation;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <i class="fas fa-book-open" style="font-size: 24px; color: white;"></i>
                            <span class="category-badge" style="background: rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="count-yasaruna">0</span>
                        </div>
                        <div style="color: white; font-size: 16px; font-weight: 600;">Yasaruna</div>
                    </div>
                    
                    <!-- Hadith Category Card -->
                    <div class="category-card" data-category="hadith" onclick="if(typeof window.filterBooks==='function')window.filterBooks('hadith')" style="background: linear-gradient(135deg, #FF9800, #F57C00); border-radius: 12px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; touch-action: manipulation;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <i class="fas fa-book-reader" style="font-size: 24px; color: white;"></i>
                            <span class="category-badge" style="background: rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="count-hadith">0</span>
                        </div>
                        <div style="color: white; font-size: 16px; font-weight: 600;">Hadith</div>
                    </div>
                    
                    <!-- Tauheed Category Card -->
                    <div class="category-card" data-category="tauheed" onclick="if(typeof window.filterBooks==='function')window.filterBooks('tauheed')" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2); border-radius: 12px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; touch-action: manipulation;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <i class="fas fa-star-and-crescent" style="font-size: 24px; color: white;"></i>
                            <span class="category-badge" style="background: rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="count-tauheed">0</span>
                        </div>
                        <div style="color: white; font-size: 16px; font-weight: 600;">Tauheed</div>
                    </div>
                    
                    <!-- Swalah Category Card -->
                    <div class="category-card" data-category="swalah" onclick="if(typeof window.filterBooks==='function')window.filterBooks('swalah')" style="background: linear-gradient(135deg, #009688, #00796B); border-radius: 12px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; touch-action: manipulation;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <i class="fas fa-mosque" style="font-size: 24px; color: white;"></i>
                            <span class="category-badge" style="background: rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="count-swalah">0</span>
                        </div>
                        <div style="color: white; font-size: 16px; font-weight: 600;">Swalah</div>
                    </div>
                    
                    <!-- Others Category Card -->
                    <div class="category-card" data-category="others" onclick="if(typeof window.filterBooks==='function')window.filterBooks('others')" style="background: linear-gradient(135deg, #757575, #616161); border-radius: 12px; padding: 16px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; touch-action: manipulation;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <i class="fas fa-folder" style="font-size: 24px; color: white;"></i>
                            <span class="category-badge" style="background: rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;" id="count-others">0</span>
                        </div>
                        <div style="color: white; font-size: 16px; font-weight: 600;">Others</div>
                    </div>
                </div>
                
                <style>
                    .category-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                    }
                    .category-card:active {
                        transform: translateY(0);
                    }
                    .category-card.active {
                        box-shadow: 0 4px 16px rgba(0,0,0,0.2) !important;
                        transform: scale(1.02);
                    }
                    
                    /* Book Card Mobile Styles */
                    .book-card {
                        -webkit-tap-highlight-color: transparent;
                    }
                    .book-card:active {
                        transform: scale(0.98) !important;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
                    }
                    
                    .book-details-btn:active,
                    .book-open-btn:active {
                        transform: scale(0.95);
                        opacity: 0.9;
                    }
                    
                    .book-details-btn:hover,
                    .book-open-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
                    }
                    
                    /* Mobile-First Document Card Styles */
                    .media-grid {
                        display: grid;
                        grid-template-columns: 1fr;
                        gap: 12px;
                        padding: 0;
                    }
                    
                    /* Mobile form styles */
                    @media (max-width: 767px) {
                        .modal-content {
                            max-width: 100% !important;
                            width: 100% !important;
                            margin: 0 !important;
                            border-radius: 0 !important;
                        }
                        
                        .form-input,
                        .form-group textarea,
                        select.form-input {
                            font-size: 16px !important; /* Prevents zoom on iOS */
                            padding: 16px !important;
                            min-height: 44px !important; /* Large tap target */
                        }
                        
                        .file-upload-button {
                            min-height: 120px !important;
                            padding: 24px 20px !important;
                        }
                        
                        #submitBookBtn {
                            min-height: 52px !important;
                            font-size: 18px !important;
                            padding: 16px !important;
                        }
                    }
                    
                    @media (min-width: 768px) {
                        .media-grid {
                            grid-template-columns: repeat(2, 1fr);
                            gap: 16px;
                        }
                    }
                    
                    .media-item {
                        width: 100%;
                        max-width: 100%;
                        min-height: auto;
                    }
                    
                    .document-card {
                        width: 100%;
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        overflow: hidden;
                        transition: all 0.2s ease;
                        -webkit-tap-highlight-color: transparent;
                        cursor: pointer;
                    }
                    
                    .document-card:active {
                        transform: scale(0.98);
                        box-shadow: 0 1px 4px rgba(0,0,0,0.12);
                    }
                    
                    .document-header {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 14px 16px;
                        border-bottom: 1px solid #f0f0f0;
                    }
                    
                    .document-icon {
                        width: 48px;
                        height: 48px;
                        border-radius: 8px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        flex-shrink: 0;
                    }
                    
                    .document-icon.pdf {
                        background: #ffebee;
                        color: #c62828;
                    }
                    
                    .document-icon.audio {
                        background: #e8f5e9;
                        color: #2e7d32;
                    }
                    
                    .document-icon.default {
                        background: #e3f2fd;
                        color: #1976d2;
                    }
                    
                    .document-title {
                        font-size: 16px;
                        font-weight: 600;
                        color: #212121;
                        line-height: 1.4;
                        margin: 0;
                        display: -webkit-box;
                        -webkit-line-clamp: 2;
                        -webkit-box-orient: vertical;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        flex: 1;
                    }
                    
                    .document-body {
                        padding: 14px 16px;
                    }
                    
                    .document-meta {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-size: 13px;
                        color: #757575;
                        margin-bottom: 10px;
                        flex-wrap: wrap;
                    }
                    
                    .document-meta-item {
                        display: flex;
                        align-items: center;
                        gap: 4px;
                    }
                    
                    .document-meta-separator {
                        color: #bdbdbd;
                    }
                    
                    .document-description {
                        font-size: 14px;
                        color: #616161;
                        line-height: 1.5;
                        margin: 0 0 12px 0;
                        display: -webkit-box;
                        -webkit-line-clamp: 2;
                        -webkit-box-orient: vertical;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }
                    
                    .document-date {
                        font-size: 12px;
                        color: #9e9e9e;
                        margin-bottom: 12px;
                    }
                    
                    .document-actions {
                        display: flex;
                        gap: 8px;
                        margin-top: 12px;
                    }
                    
                    .document-btn {
                        flex: 1;
                        min-height: 44px;
                        padding: 12px 16px;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        touch-action: manipulation;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 6px;
                    }
                    
                    .document-btn:active {
                        transform: scale(0.95);
                        opacity: 0.9;
                    }
                    
                    .document-btn-open {
                        background: linear-gradient(135deg, #4CAF50, #388E3C);
                        color: white;
                        box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
                    }
                    
                    .document-btn-delete {
                        background: #f44336;
                        color: white;
                        min-width: 44px;
                        flex: 0 0 auto;
                        box-shadow: 0 2px 6px rgba(244, 67, 54, 0.3);
                    }
                    
                    @media (max-width: 767px) {
                        .document-actions {
                            flex-direction: column;
                        }
                        
                        .document-btn {
                            width: 100%;
                        }
                        
                        .document-btn-delete {
                            width: 100%;
                        }
                    }
                </style>

                <div class="media-grid" id="libraryGrid">
                    <!-- Books will be loaded here dynamically -->
                </div>

                <div class="info-card" style="margin-top: 20px;">
                    <h3><i class="fas fa-info-circle"></i> About Our Library</h3>
                    <p>Browse through our collection of Islamic books, educational resources, and Quranic studies materials. All books are carefully selected to support Islamic learning and community education.</p>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="index.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="programs.html" class="nav-item"><i class="fas fa-book"></i><span>Programs</span></a>
            <a href="events.html" class="nav-item"><i class="fas fa-calendar"></i><span>Events</span></a>
            <a href="pay.html" class="nav-item"><i class="fas fa-credit-card"></i><span>Pay</span></a>
            <a href="join-us.html" class="nav-item" id="accountNavItem"><i class="fas fa-user-circle"></i><span id="accountNavText">Account</span></a>
        </nav>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <!-- Load singleton Supabase client first (as module) -->
    <script type="module" src="services/supabaseClient.js"></script>
    <script type="module" src="js/library.js"></script>
    <script src="script.js"></script>
    <script src="update-navigation.js"></script>
    <script>
        // Define showAddBookModal immediately so it's available for onclick handlers
        window.showAddBookModal = function() {
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (!adminStatus) {
                if (typeof window.showAdminLogin === 'function') {
                    window.showAdminLogin();
                } else {
                    alert('Please login as admin first. Click the "Admin Login" button.');
                }
                return;
            }
            const modal = document.getElementById('addBookModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.zIndex = '9999';
                console.log('Add Book modal opened');
            } else {
                console.error('Add Book modal not found');
                alert('Error: Add Book form not found. Please refresh the page.');
            }
        };

        // Check admin status on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Check admin status in background (non-blocking)
            if (typeof window.checkAdminStatus === 'function') {
                setTimeout(() => {
                    window.checkAdminStatus();
                }, 0);
            } else if (typeof checkAdminStatus === 'function') {
                setTimeout(() => {
                    checkAdminStatus();
                }, 0);
            }
            
            loadBooksFromStorage('all', true);
            
            // Refresh books in background every 30 seconds (only when page is visible)
            let refreshInterval = null;
            const startBackgroundRefresh = () => {
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(() => {
                    // Only refresh if page is visible (saves battery/data)
                    if (!document.hidden) {
                        loadBooksFromStorage('all', false); // Silent refresh
                    }
                }, 30000);
            };
            
            // Start refresh when page is visible
            startBackgroundRefresh();
            
            // Pause refresh when page is hidden, resume when visible
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    if (refreshInterval) clearInterval(refreshInterval);
                } else {
                    startBackgroundRefresh();
                }
            });
            
            // Initialize admin login modal
            const adminModal = document.getElementById('adminLoginModal');
            if (adminModal) {
                adminModal.addEventListener('click', function(e) {
                    if (e.target === adminModal) {
                        closeAdminLogin();
                    }
                });
            }
            
            // File input change handler - auto-detect file type and update display
            // Attached after DOM is fully loaded for mobile compatibility
            function attachFileInputHandler() {
                const bookFileInput = document.getElementById('bookFile');
                const fileNameDisplay = document.getElementById('fileNameDisplay');
                const fileTypeDisplay = document.getElementById('fileTypeDisplay');
                const bookTypeHidden = document.getElementById('bookType');
                
                if (!bookFileInput || !fileNameDisplay || !fileTypeDisplay || !bookTypeHidden) {
                    // Elements not ready yet, try again after a short delay
                    setTimeout(attachFileInputHandler, 100);
                    return;
                }
                
                bookFileInput.addEventListener('change', function(e) {
                    const file = e.target.files && e.target.files[0];
                    if (file) {
                        // Show file name
                        fileNameDisplay.textContent = 'Selected: ' + file.name;
                        fileNameDisplay.style.display = 'block';
                        
                        // Harden mobile file type detection - use both MIME type AND filename extension
                        // Handle empty or "application/octet-stream" MIME types
                        const fileName = file.name.toLowerCase();
                        const fileMimeType = file.type || '';
                        
                        // Audio file detection (check both MIME type and extension)
                        const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.aac', '.flac'];
                        const isAudioByExtension = audioExtensions.some(ext => fileName.endsWith(ext));
                        const isAudioByMime = fileMimeType.startsWith('audio/') && 
                                             fileMimeType !== 'application/octet-stream' &&
                                             fileMimeType !== '';
                        const isAudioFile = isAudioByMime || isAudioByExtension;
                        
                        // PDF file detection (check both MIME type and extension)
                        const isPdfByExtension = fileName.endsWith('.pdf');
                        const isPdfByMime = (fileMimeType === 'application/pdf') && 
                                          fileMimeType !== 'application/octet-stream' &&
                                          fileMimeType !== '';
                        const isPdfFile = isPdfByMime || isPdfByExtension;
                        
                        let detectedType = '';
                        let typeIcon = '';
                        let typeColor = '#666';
                        
                        if (isAudioFile) {
                            detectedType = 'Audio';
                            typeIcon = 'üéß';
                            typeColor = '#2e7d32';
                            bookTypeHidden.value = 'audio';
                        } else if (isPdfFile) {
                            detectedType = 'PDF';
                            typeIcon = 'üìÑ';
                            typeColor = '#c62828';
                            bookTypeHidden.value = 'pdf';
                        } else {
                            detectedType = 'Unknown';
                            typeIcon = 'üìÅ';
                            typeColor = '#666';
                            bookTypeHidden.value = '';
                        }
                        
                        // Update file type display
                        fileTypeDisplay.innerHTML = `<i class="fas fa-${isAudioFile ? 'headphones' : isPdfFile ? 'file-pdf' : 'file'}" style="color: ${typeColor};"></i> ${detectedType} (auto-detected)`;
                        fileTypeDisplay.style.borderColor = typeColor;
                        fileTypeDisplay.style.background = isAudioFile ? '#e8f5e9' : isPdfFile ? '#ffebee' : '#f5f5f5';
                        fileTypeDisplay.style.color = '#212121';
                    } else {
                        // No file selected - reset all displays
                        fileNameDisplay.style.display = 'none';
                        fileTypeDisplay.innerHTML = '<i class="fas fa-info-circle"></i> Will be detected automatically from file';
                        fileTypeDisplay.style.borderColor = '#e0e0e0';
                        fileTypeDisplay.style.background = '#f5f5f5';
                        fileTypeDisplay.style.color = '#666';
                        bookTypeHidden.value = '';
                    }
                });
            }
            
            // Attach handler after DOM is fully loaded
            attachFileInputHandler();
            
            // Allow Enter key to submit password
            const passwordInput = document.getElementById('adminPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        if (typeof window.verifyAdminPassword === 'function') {
                            window.verifyAdminPassword();
                        }
                    }
                });
            }

            // Close add book modal on overlay click
            const addBookModal = document.getElementById('addBookModal');
            if (addBookModal) {
                addBookModal.addEventListener('click', function(e) {
                    if (e.target === addBookModal) {
                        if (typeof window.closeAddBookModal === 'function') {
                            window.closeAddBookModal();
                        }
                    }
                });
            }
        });

        // Filter books function - globally accessible
        window.filterBooks = function(category) {
            // Update category card active states
            const categoryCards = document.querySelectorAll('.category-card');
            categoryCards.forEach(card => {
                const cardCategory = card.dataset.category || '';
                if (cardCategory === category) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
            
            // Instant client-side filtering (no reload)
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            displayBooks(cachedBooks, category, adminStatus);
        };
        
        // Update category counts
        function updateCategoryCounts(books) {
            const categories = ['all', 'quran', 'yasaruna', 'hadith', 'tauheed', 'swalah', 'others'];
            
            categories.forEach(cat => {
                const badge = document.getElementById(`count-${cat}`);
                if (badge) {
                    let count = 0;
                    if (cat === 'all') {
                        count = books.length;
                    } else {
                        count = books.filter(book => {
                            const bookCategory = (book.category || 'others').toLowerCase();
                            return bookCategory === cat.toLowerCase();
                        }).length;
                    }
                    badge.textContent = count;
                }
            });
        }

        window.closeAddBookModal = function() {
            const modal = document.getElementById('addBookModal');
            if (modal) {
                modal.style.display = 'none';
            }
            const form = document.getElementById('uploadBookForm');
            if (form) {
                form.reset();
            }
        };

        /**
         * New Add Book handler - Supabase-only implementation
         * Uploads files to Supabase Storage, then inserts into books table
         */
        window.addBook = async function(e) {
            if (e) {
                e.preventDefault();
            }
            
            // Check admin login status
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (!adminStatus) {
                alert('You must be logged in as admin to add books.');
                if (typeof window.showAdminLogin === 'function') {
                    window.showAdminLogin();
                }
                return false;
            }

            // Get form inputs
            const nameInput = document.getElementById('bookName');
            const typeInput = document.getElementById('bookType'); // Hidden input, auto-filled
            const categoryInput = document.getElementById('bookCategory');
            const descriptionInput = document.getElementById('bookDescription');
            const bookFileInput = document.getElementById('bookFile');
            
            const title = nameInput ? nameInput.value.trim() : '';
            const category = categoryInput ? categoryInput.value : '';
            const description = descriptionInput ? descriptionInput.value.trim() : '';
            
            // Validation: Required fields
            if (!title || !category) {
                alert('Please fill in book name and category.');
                return false;
            }
            
            // Validation: Book file is required
            if (!bookFileInput || !bookFileInput.files || !bookFileInput.files[0]) {
                alert('Please select a book file (PDF or audio).');
                return false;
            }
            
            const bookFile = bookFileInput.files[0];
            
            // Harden mobile file type detection - use both MIME type AND filename extension
            // Handle empty or "application/octet-stream" MIME types
            const fileName = bookFile.name.toLowerCase();
            const fileMimeType = bookFile.type || '';
            
            // Audio file detection (check both MIME type and extension)
            const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.aac', '.flac'];
            const isAudioByExtension = audioExtensions.some(ext => fileName.endsWith(ext));
            const isAudioByMime = fileMimeType.startsWith('audio/') && 
                                 fileMimeType !== 'application/octet-stream' &&
                                 fileMimeType !== '';
            const isAudioFile = isAudioByMime || isAudioByExtension;
            
            // PDF file detection (check both MIME type and extension)
            const isPdfByExtension = fileName.endsWith('.pdf');
            const isPdfByMime = (fileMimeType === 'application/pdf') && 
                              fileMimeType !== 'application/octet-stream' &&
                              fileMimeType !== '';
            const isPdfFile = isPdfByMime || isPdfByExtension;
            
            if (!isAudioFile && !isPdfFile) {
                alert('Please select a PDF or audio file (MP3, WAV, OGG, M4A).');
                return false;
            }
            
            // Set file type (auto-detected)
            const bookType = isAudioFile ? 'audio' : 'pdf';
            if (typeInput) {
                typeInput.value = bookType;
            }
            
            // Validate file size (max 100MB)
            const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB
            if (bookFile.size > MAX_FILE_SIZE) {
                alert(`File size (${(bookFile.size / (1024 * 1024)).toFixed(2)}MB) exceeds maximum of 100MB.`);
                return false;
            }
            
            // Get submit button and disable it
            const submitBtn = document.getElementById('submitBookBtn');
            if (!submitBtn) {
                console.error('Submit button not found');
                return false;
            }
            
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            let fileUrl = '';
            const fileType = bookType; // Use the selected book type
            
            try {
                // STEP 1: Upload book file to Supabase Storage
                // Ensure correct content type for PDFs
                const uploadOptions = {};
                if (isPdfFile) {
                    uploadOptions.contentType = 'application/pdf';
                }
                
                if (window.uploadService && window.uploadService.uploadFile) {
                    const uploadResult = await window.uploadService.uploadFile(bookFile, 'books', uploadOptions);
                    if (uploadResult && uploadResult.success) {
                        fileUrl = uploadResult.url;
                        console.log('Book file uploaded:', fileUrl);
                    } else {
                        throw new Error('Failed to upload book file');
                    }
                } else {
                    throw new Error('Upload service not available');
                }
                
                // STEP 2: Insert record into books table
                // Normalize category to lowercase for consistency
                const normalizedCategory = category ? category.toLowerCase() : 'others';
                const bookData = {
                    title: title,
                    author: '', // No author field in new form
                    category: normalizedCategory,
                    description: description || null,
                    cover_url: null, // No cover image in new form
                    file_url: fileUrl,
                    file_type: fileType
                };
                
                const supabase = getSupabaseClient();
                if (!supabase) {
                    throw new Error('Supabase client not available');
                }
                
                const { data, error } = await supabase
                    .from('books')
                    .insert([bookData])
                    .select();
                
                if (error) {
                    throw error;
                }
                
                if (data && data.length > 0) {
                    console.log('Book uploaded successfully');
                    
                    // STEP 4: Refresh library list
                    loadBooksFromStorage('all', false);
                    
                    // Close modal and reset form
                    window.closeAddBookModal();
                    alert('Book added successfully!');
                } else {
                    throw new Error('No data returned from insert');
                }
                
            } catch (error) {
                console.error('Error adding book:', error);
                alert('Error: Failed to add book. ' + (error.message || 'Please try again.'));
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        };


        // Show book details modal
        window.showBookDetails = function(bookId) {
            const cachedBooks = JSON.parse(localStorage.getItem('cachedBooks') || '[]');
            const book = cachedBooks.find(b => b.id.toString() === bookId.toString());
            
            if (!book) {
                alert('Book not found.');
                return;
            }
            
            // Sanitize all inputs
            const safeTitle = sanitizeHTML(book.title || 'Untitled');
            const safeAuthor = sanitizeHTML(book.author || 'Unknown Author');
            const safeDescription = sanitizeHTML(book.description || 'No description available.');
            const safeCover = sanitizeURL(book.cover_image_url || '');
            const safeISBN = sanitizeHTML(book.isbn || 'N/A');
            const safeCategory = sanitizeHTML((book.category || 'others').toUpperCase());
            const safeType = sanitizeHTML((book.type || 'pdf').toUpperCase());
            
            // Create modal HTML
            const modalHTML = `
                <div class="modal-overlay" id="bookDetailsModal" style="display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; padding: 20px;">
                    <div class="modal-content" style="background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative;">
                        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 1; border-radius: 16px 16px 0 0;">
                            <h3 style="margin: 0; font-size: 20px; color: var(--dark-gray);"><i class="fas fa-book-open" style="color: var(--primary-green);"></i> Book Details</h3>
                            <button onclick="closeBookDetailsModal()" style="background: none; border: none; font-size: 24px; color: #999; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f5f5f5'; this.style.color='#333';" onmouseout="this.style.background='none'; this.style.color='#999';">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" style="padding: 20px;">
                            ${safeCover ? `<img src="${safeCover}" alt="${safeTitle}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">` : 
                            `<div style="width: 100%; height: 200px; background: linear-gradient(135deg, var(--primary-green), var(--dark-green)); display: flex; align-items: center; justify-content: center; color: white; font-size: 64px; border-radius: 12px; margin-bottom: 20px;">
                                <i class="fas fa-book"></i>
                            </div>`}
                            
                            <h2 style="margin: 0 0 10px 0; font-size: 24px; font-weight: 700; color: var(--dark-gray); line-height: 1.3;">${safeTitle}</h2>
                            
                            <div style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                <p style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-gray);"><strong style="color: var(--dark-gray);">Author:</strong> ${safeAuthor}</p>
                                <p style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-gray);"><strong style="color: var(--dark-gray);">Category:</strong> ${safeCategory}</p>
                                <p style="margin: 0 0 8px 0; font-size: 16px; color: var(--text-gray);"><strong style="color: var(--dark-gray);">Type:</strong> ${safeType}</p>
                                <p style="margin: 0; font-size: 16px; color: var(--text-gray);"><strong style="color: var(--dark-gray);">ISBN:</strong> ${safeISBN}</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: var(--dark-gray);">Description</h4>
                                <p style="margin: 0; font-size: 15px; color: var(--text-gray); line-height: 1.6;">${safeDescription}</p>
                            </div>
                            
                            ${book.file_url ? `<button onclick="window.open('${book.file_url}', '_blank'); closeBookDetailsModal();" style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary-green), var(--dark-green)); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); transition: all 0.2s; touch-action: manipulation; display: flex; align-items: center; justify-content: center; gap: 8px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(76, 175, 80, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(76, 175, 80, 0.3)';">
                                <i class="fas fa-external-link-alt"></i> Open Book
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('bookDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Close on overlay click
            const modal = document.getElementById('bookDetailsModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeBookDetailsModal();
                }
            });
        };
        
        // Close book details modal
        window.closeBookDetailsModal = function() {
            const modal = document.getElementById('bookDetailsModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 200);
            }
        };

        // Delete book function - admin only
        window.deleteBook = async function(bookId) {
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (!adminStatus) {
                alert('You must be logged in as admin to delete books.');
                return;
            }
            
            // Sanitize bookId to prevent XSS
            const safeBookId = sanitizeHTML(bookId.toString());
            
            // Use custom confirm dialog (mobile-friendly)
            if (!confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
                return;
            }
            
            const adminPassword = prompt('Enter admin password to confirm deletion:');
            if (!adminPassword || adminPassword !== 'kiuma2025') {
                if (adminPassword) {
                    alert('Incorrect password.');
                }
                return;
            }
            
            try {
                const supabase = getSupabaseClient();
                if (!supabase) {
                    throw new Error('Supabase client not available');
                }
                
                console.log('Attempting to delete book with ID:', safeBookId);
                
                // Delete from Supabase - simple and direct
                const { data, error } = await supabase
                    .from('books')
                    .delete()
                    .eq('id', safeBookId)
                    .select();
                
                if (error) {
                    console.error('Supabase delete error:', error);
                    throw error;
                }
                
                console.log('Book deleted successfully from Supabase:', data);
                
                // Remove from cache immediately
                cachedBooks = cachedBooks.filter(book => {
                    const bookIdStr = book.id?.toString() || '';
                    const supabaseIdStr = book.supabaseId?.toString() || '';
                    return bookIdStr !== safeBookId && supabaseIdStr !== safeBookId;
                });
                
                // Update localStorage cache
                try {
                    localStorage.setItem('cachedBooks', JSON.stringify(cachedBooks));
                } catch (e) {
                    console.log('Cache save failed:', e);
                }
                
                // Update UI immediately
                const currentCategory = document.querySelector('.category-card.active')?.dataset.category || 'all';
                const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
                displayBooks(cachedBooks, currentCategory, adminStatus);
                
                // Refresh from database in background
                setTimeout(() => {
                    loadBooksFromStorage(currentCategory, false);
                }, 500);
                
                alert('Book deleted successfully!');
            } catch (error) {
                console.error('Error deleting book:', error);
                alert('Error: Failed to delete book. ' + (error.message || 'Please try again.'));
            }
        };

        // Helper function to clear old books (keeps last N items)
        window.clearOldBooks = function(keepCount = 10) {
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            if (!adminStatus) {
                alert('You must be logged in as admin to clear books.');
                return;
            }
            
            if (!confirm(`This will keep only the ${keepCount} most recent books. Continue?`)) {
                return;
            }
            
            try {
                let libraryData = JSON.parse(localStorage.getItem('libraryData') || '[]');
                if (libraryData.length <= keepCount) {
                    alert('No old books to clear. You have ' + libraryData.length + ' books.');
                    return;
                }
                
                const removed = libraryData.length - keepCount;
                libraryData = libraryData.slice(0, keepCount); // Keep only the first N (most recent)
                localStorage.setItem('libraryData', JSON.stringify(libraryData));
                
                // Reload books display
                loadBooksFromStorage();
                alert(`Cleared ${removed} old books. Kept ${keepCount} most recent books.`);
            } catch (e) {
                console.error('Error clearing old books:', e);
                alert('Error clearing books. Please try again.');
            }
        };

        // Sanitize HTML to prevent XSS
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Sanitize URL to prevent XSS
        function sanitizeURL(url) {
            if (!url) return '';
            // Basic URL validation - only allow http/https/data URLs
            try {
                const urlObj = new URL(url);
                if (!['http:', 'https:', 'data:'].includes(urlObj.protocol)) {
                    return '';
                }
                return url;
            } catch (e) {
                // If URL parsing fails, return empty
                return '';
            }
        }
        
        // Get Supabase client - Use singleton from services/supabaseClient.js
        function getSupabaseClient() {
            // Use the singleton client if available (preferred method)
            if (typeof window.getSupabaseClient === 'function') {
                try {
                    return window.getSupabaseClient();
                } catch (error) {
                    console.error('[Library] Error getting singleton client:', error);
                    throw error;
                }
            }
            
            // Fallback to deprecated method (for backward compatibility)
            if (typeof initializeSupabase === 'function') {
                const client = initializeSupabase();
                if (client) {
                    return client;
                }
            }
            
            throw new Error('Supabase not initialized. Make sure services/supabaseClient.js is loaded with type="module".');
        }
        
        
        // Validate file before upload
        function validateBookFile(file) {
            const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB
            const allowedTypes = ['application/pdf', 'application/epub+zip', 'application/x-mobipocket-ebook'];
            
            // Check file size
            if (file.size > MAX_FILE_SIZE) {
                return { valid: false, error: `File size (${(file.size / (1024 * 1024)).toFixed(2)}MB) exceeds maximum allowed size of 100MB.` };
            }
            
            // Check file type
            const isValidType = allowedTypes.includes(file.type) || file.name.toLowerCase().endsWith('.pdf') || file.name.toLowerCase().endsWith('.epub');
            if (!isValidType) {
                return { valid: false, error: `File type "${file.type || file.name}" is not supported. Please upload a PDF or EPUB file.` };
            }
            
            return { valid: true };
        }
        
        // Track if we've already logged API warnings (reduce console noise)
        let cachedBooks = []; // Cache books for instant filtering
        
        /**
         * Load library items from Supabase (read-only)
         * Uses books table exclusively
         */
        async function loadBooksFromStorage(category = 'all', showLoading = true) {
            const adminStatus = localStorage.getItem('isAdminLoggedIn') === 'true';
            const libraryGrid = document.getElementById('libraryGrid');
            
            if (!libraryGrid) {
                console.error('Library grid not found');
                return;
            }
            
            // Try to load from localStorage cache first (instant display)
            if (cachedBooks.length === 0) {
                try {
                    const cached = localStorage.getItem('cachedBooks');
                    if (cached) {
                        cachedBooks = JSON.parse(cached);
                        if (cachedBooks.length > 0) {
                            displayBooks(cachedBooks, category, adminStatus);
                            showLoading = false; // Already showing cached data
                        }
                    }
                } catch (e) {
                    console.log('Cache load failed:', e);
                }
            } else if (showLoading) {
                // Show cached data immediately if available
                displayBooks(cachedBooks, category, adminStatus);
                showLoading = false;
            }
            
            // Show loading state if grid is empty
            if (showLoading) {
                const existingItems = Array.from(libraryGrid.querySelectorAll('.media-item[data-id]'));
                if (existingItems.length === 0) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 40px; color: #999;';
                    loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 10px;"></i><p>Loading books...</p>';
                    loadingDiv.id = 'booksLoadingDiv';
                    libraryGrid.appendChild(loadingDiv);
                } else {
                    // Clear existing items
                    existingItems.forEach(item => item.remove());
                }
            }
            
            // Fetch from Supabase books table (exclusive, no fallbacks)
            let books = [];
            let fetchError = null;
            
            try {
                const supabase = getSupabaseClient();
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }
                
                // Build query: select all from books, ordered by created_at DESC
                // DO NOT filter by category here - fetch all books and filter client-side
                let query = supabase
                    .from('books')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                // Execute query with timeout protection
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout: Please check your connection')), 10000)
                );
                
                const { data, error } = await Promise.race([
                    query,
                    timeoutPromise.then(() => ({ data: null, error: new Error('Request timeout') }))
                ]);
                
                if (error) {
                    throw error;
                }
                
                if (data) {
                    // Log fetched items for verification
                    console.log('Fetched library items from Supabase:', data.length, 'items');
                    if (data.length > 0) {
                        console.log('Sample item:', data[0]);
                    }
                    
                    // Map Supabase data to book objects
                    books = data.map(item => ({
                        id: item.id?.toString() || '',
                        title: item.title || '',
                        author: item.author || '',
                        description: item.description || '',
                        category: item.category || 'other',
                        cover_image_url: item.cover_url || item.cover_image_url || '',
                        file_url: item.file_url || '',
                        isbn: item.isbn || '',
                        supabaseId: item.id?.toString() || ''
                    }));
                }
            } catch (error) {
                fetchError = error;
                console.error('Error fetching library items from Supabase:', error);
            }
            
            // Update cache
            cachedBooks = books;
            
            // Save to localStorage for instant load next time (with quota handling)
            try {
                localStorage.setItem('cachedBooks', JSON.stringify(cachedBooks));
            } catch (e) {
                console.log('Cache save failed:', e);
                // If quota exceeded, try to clear old cache
                if (e.name === 'QuotaExceededError') {
                    try {
                        const limitedCache = cachedBooks.slice(0, 50);
                        localStorage.setItem('cachedBooks', JSON.stringify(limitedCache));
                    } catch (e2) {
                        console.error('Error clearing cache:', e2);
                    }
                }
            }
            
            // Remove ALL existing content first (loading, empty states, errors, books)
            // This prevents stacking of multiple states
            const allExistingContent = Array.from(libraryGrid.querySelectorAll('div'));
            allExistingContent.forEach(item => item.remove());
            const existingItems = Array.from(libraryGrid.querySelectorAll('.media-item[data-id]'));
            existingItems.forEach(item => item.remove());
            
            // Handle states: success, empty, or error
            if (fetchError) {
                // Error state: show ONE user-friendly message
                const errorDiv = document.createElement('div');
                errorDiv.id = 'booksErrorState';
                errorDiv.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 40px; color: #999;';
                errorDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 10px; opacity: 0.5; color: #f44336;"></i>
                    <p style="margin-bottom: 10px;">Unable to load books. Please check your connection.</p>
                    <button onclick="loadBooksFromStorage('${category}', true)" class="btn btn-primary" style="margin-top: 10px; padding: 8px 16px;">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                `;
                libraryGrid.appendChild(errorDiv);
            } else if (books.length === 0) {
                // Empty state: no books available - let displayBooks handle it
                displayBooks([], category, adminStatus);
            } else {
                // Success state: display books
                displayBooks(cachedBooks, category, adminStatus);
            }
        }
        
        // Display books (instant, no loading)
        function displayBooks(books, category = 'all', adminStatus = false) {
            const libraryGrid = document.getElementById('libraryGrid');
            if (!libraryGrid) return;
            
            // Update category counts
            updateCategoryCounts(books);
            
            // Filter by category (client-side, instant)
            let filtered = books;
            if (category !== 'all') {
                filtered = books.filter(book => {
                    const bookCategory = (book.category || 'others').toLowerCase();
                    return bookCategory === category.toLowerCase();
                });
            }
            
            // Remove ALL existing content: loading indicators, empty states, error messages, and book items
            // This prevents stacking of empty states
            const allExistingContent = Array.from(libraryGrid.querySelectorAll('div'));
            allExistingContent.forEach(item => item.remove());
            
            // Clear existing book items
            const existingItems = Array.from(libraryGrid.querySelectorAll('.media-item[data-id]'));
            existingItems.forEach(item => item.remove());
            
            // Show empty state ONLY when appropriate (mobile-friendly)
            // Rule 1: If total books array is empty, show ONE message for "all" category
            // Rule 2: If filtering by category and that category has no books, show message for that category only
            if (books.length === 0 && category === 'all') {
                // Total books array is empty - show single empty state
                const emptyDiv = document.createElement('div');
                emptyDiv.id = 'booksEmptyState';
                emptyDiv.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #999;';
                emptyDiv.innerHTML = '<i class="fas fa-book" style="font-size: 64px; margin-bottom: 16px; opacity: 0.3; color: #bdbdbd;"></i><p style="font-size: 16px; margin: 0; color: #757575;">No documents available yet</p>';
                libraryGrid.appendChild(emptyDiv);
                return;
            } else if (filtered.length === 0 && category !== 'all' && books.length > 0) {
                // Category filter active, but no books in that category (other books exist)
                const emptyDiv = document.createElement('div');
                emptyDiv.id = 'booksEmptyState';
                emptyDiv.style.cssText = 'grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #999;';
                const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                emptyDiv.innerHTML = '<i class="fas fa-folder-open" style="font-size: 64px; margin-bottom: 16px; opacity: 0.3; color: #bdbdbd;"></i><p style="font-size: 16px; margin: 0; color: #757575;">No documents in ' + categoryName + ' category</p>';
                libraryGrid.appendChild(emptyDiv);
                return;
            }
            
            // If we have books to display, ensure no empty state is shown
            if (filtered.length > 0) {
                const existingEmptyState = document.getElementById('booksEmptyState');
                if (existingEmptyState) {
                    existingEmptyState.remove();
                }
            }
            
            // Render books as mobile-first document cards
            filtered.forEach(book => {
                const newBookItem = document.createElement('div');
                newBookItem.className = 'media-item';
                newBookItem.dataset.category = (book.category || 'others').toLowerCase();
                newBookItem.dataset.id = book.id;
                
                // Sanitize all inputs to prevent XSS
                const safeTitle = sanitizeHTML(book.title || 'Untitled');
                const safeAuthor = sanitizeHTML(book.author || '');
                const safeDescription = sanitizeHTML(book.description || '');
                const safeCategory = sanitizeHTML((book.category || 'others').toUpperCase());
                const safeId = sanitizeHTML(book.id.toString());
                
                // Use Supabase public URL from books table (file_url column)
                let fileUrl = '';
                if (book.file_url && book.file_url.startsWith('http')) {
                    fileUrl = book.file_url;
                }
                
                // Detect file type from URL or type field
                let fileType = 'default';
                let fileIcon = 'üìÑ';
                let fileTypeClass = 'default';
                
                if (book.type) {
                    if (book.type.toLowerCase() === 'audio' || book.type.toLowerCase().includes('audio')) {
                        fileType = 'audio';
                        fileIcon = 'üéß';
                        fileTypeClass = 'audio';
                    } else if (book.type.toLowerCase() === 'pdf' || book.type.toLowerCase().includes('pdf')) {
                        fileType = 'pdf';
                        fileIcon = 'üìÑ';
                        fileTypeClass = 'pdf';
                    }
                } else if (fileUrl) {
                    const urlLower = fileUrl.toLowerCase();
                    if (urlLower.includes('.mp3') || urlLower.includes('.wav') || urlLower.includes('.ogg') || urlLower.includes('.m4a')) {
                        fileType = 'audio';
                        fileIcon = 'üéß';
                        fileTypeClass = 'audio';
                    } else if (urlLower.includes('.pdf')) {
                        fileType = 'pdf';
                        fileIcon = 'üìÑ';
                        fileTypeClass = 'pdf';
                    }
                }
                
                // Format file size if available
                let fileSizeDisplay = '';
                if (book.file_size) {
                    const sizeBytes = parseInt(book.file_size);
                    if (!isNaN(sizeBytes)) {
                        if (sizeBytes < 1024) {
                            fileSizeDisplay = sizeBytes + ' B';
                        } else if (sizeBytes < 1024 * 1024) {
                            fileSizeDisplay = (sizeBytes / 1024).toFixed(1) + ' KB';
                        } else {
                            fileSizeDisplay = (sizeBytes / (1024 * 1024)).toFixed(1) + ' MB';
                        }
                    }
                }
                
                // Format date if available
                let dateDisplay = '';
                if (book.created_at) {
                    try {
                        const date = new Date(book.created_at);
                        if (!isNaN(date.getTime())) {
                            dateDisplay = date.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        }
                    } catch (e) {
                        // Invalid date, skip
                    }
                }
                
                // Build meta line
                const metaItems = [];
                if (safeCategory) metaItems.push(safeCategory);
                if (fileSizeDisplay) metaItems.push(fileSizeDisplay);
                const metaLine = metaItems.join(' ‚Ä¢ ');
                
                // Card click handler - opens file if available
                const cardClickHandler = fileUrl ? `onclick="window.open('${fileUrl}', '_blank')"` : '';
                
                newBookItem.innerHTML = `
                    <div class="document-card" ${cardClickHandler}>
                        <div class="document-header">
                            <div class="document-icon ${fileTypeClass}">
                                <i class="fas ${fileType === 'audio' ? 'fa-headphones' : fileType === 'pdf' ? 'fa-file-pdf' : 'fa-file'}"></i>
                            </div>
                            <h3 class="document-title">${safeTitle}</h3>
                        </div>
                        <div class="document-body">
                            ${metaLine ? `<div class="document-meta">${metaLine}</div>` : ''}
                            ${safeDescription ? `<p class="document-description">${safeDescription}</p>` : ''}
                            ${dateDisplay ? `<div class="document-date">Uploaded ${dateDisplay}</div>` : ''}
                            <div class="document-actions">
                                ${fileUrl ? `<button class="document-btn document-btn-open" onclick="event.stopPropagation(); window.open('${fileUrl}', '_blank')" aria-label="Open document">
                                    <i class="fas fa-external-link-alt"></i>
                                    <span>Open</span>
                                </button>` : ''}
                                ${adminStatus ? `<button class="document-btn document-btn-delete" onclick="event.stopPropagation(); deleteBook('${safeId}')" aria-label="Delete document">
                                    <i class="fas fa-trash"></i>
                                    ${window.innerWidth > 767 ? '<span>Delete</span>' : ''}
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                libraryGrid.insertBefore(newBookItem, libraryGrid.firstChild);
            });
        }
        
        // Re-render books when admin status changes
        window.addEventListener('storage', function(e) {
            if (e.key === 'isAdminLoggedIn') {
                loadBooksFromStorage();
            }
        });
    </script>

    <!-- Admin Login Modal -->
    <div class="modal-overlay" id="adminLoginModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-shield-alt"></i> Admin Login</h3>
                <button class="modal-close" onclick="closeAdminLogin()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Sign in with your account to access admin features.</p>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="adminEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="adminPassword" placeholder="Enter your password">
                    <p id="passwordError" style="color: #f44336; font-size: 14px; margin-top: 5px; display: none;">Incorrect email or password.</p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="if(typeof window.verifyAdminPassword==='function')window.verifyAdminPassword()" style="flex: 1;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <button class="btn btn-secondary" onclick="if(typeof window.closeAdminLogin==='function')window.closeAdminLogin()" style="flex: 1;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Book Modal - Simple Mobile-First Form -->
    <div class="modal-overlay" id="addBookModal" style="display: none;">
        <div class="modal-content" style="max-width: 100%; width: 100%; margin: 0; border-radius: 0; height: 100vh; max-height: 100vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h3><i class="fas fa-book"></i> Add New Book</h3>
                <button class="modal-close" onclick="if(typeof window.closeAddBookModal==='function')window.closeAddBookModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px;">
                <form id="uploadBookForm" onsubmit="event.preventDefault(); if(typeof window.addBook==='function'){window.addBook(event);} return false;" enctype="multipart/form-data">
                    <!-- Book Name -->
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label" style="font-size: 16px; font-weight: 600; margin-bottom: 10px; display: block; color: var(--dark-gray, #333);">Book Name *</label>
                        <input type="text" class="form-input" id="bookName" placeholder="Enter book name" required maxlength="200" style="width: 100%; padding: 16px; font-size: 16px; border: 2px solid #ddd; border-radius: 12px; box-sizing: border-box; -webkit-appearance: none; appearance: none;">
                    </div>
                    
                    <!-- File Type (Auto-detected, read-only display) -->
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label" style="font-size: 16px; font-weight: 600; margin-bottom: 10px; display: block; color: var(--dark-gray, #333);">File Type</label>
                        <div id="fileTypeDisplay" style="width: 100%; padding: 16px; font-size: 16px; border: 2px solid #e0e0e0; border-radius: 12px; box-sizing: border-box; background: #f5f5f5; color: #666;">
                            <i class="fas fa-info-circle"></i> Will be detected automatically from file
                        </div>
                        <input type="hidden" id="bookType" value="">
                    </div>
                    
                    <!-- Category -->
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label" style="font-size: 16px; font-weight: 600; margin-bottom: 10px; display: block; color: var(--dark-gray, #333);">Category *</label>
                        <select class="form-input" id="bookCategory" required style="width: 100%; padding: 16px; font-size: 16px; border: 2px solid #ddd; border-radius: 12px; box-sizing: border-box; -webkit-appearance: none; appearance: none; background-image: url(&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E&quot;); background-repeat: no-repeat; background-position: right 12px center; background-size: 20px; padding-right: 40px;">
                            <option value="">Select category</option>
                            <option value="quran">Quran</option>
                            <option value="yasaruna">Yasaruna</option>
                            <option value="hadith">Hadith</option>
                            <option value="tauheed">Tauheed</option>
                            <option value="swalah">Swalah</option>
                            <option value="others">Others</option>
                        </select>
                    </div>
                    
                    <!-- Description -->
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label" style="font-size: 16px; font-weight: 600; margin-bottom: 10px; display: block; color: var(--dark-gray, #333);">Description (Optional)</label>
                        <textarea class="form-input" id="bookDescription" rows="4" placeholder="Enter book description" maxlength="2000" style="width: 100%; padding: 16px; font-size: 16px; border: 2px solid #ddd; border-radius: 12px; resize: vertical; box-sizing: border-box; font-family: inherit; min-height: 100px;"></textarea>
                    </div>
                    
                    <!-- File Upload (Mobile-Safe) -->
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label class="form-label" style="font-size: 16px; font-weight: 600; margin-bottom: 10px; display: block; color: var(--dark-gray, #333);">Upload File *</label>
                        <label for="bookFile" style="display: block; width: 100%; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">
                            <!-- File input positioned off-screen (mobile-safe, no display:none) -->
                            <input type="file" id="bookFile" name="bookFile" accept=".pdf,.mp3,.wav,.ogg,.m4a,audio/*,application/pdf" required style="position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0; overflow: hidden;">
                            <div class="file-upload-button" style="width: 100%; min-height: 120px; padding: 24px 20px; font-size: 16px; border: 3px dashed #4CAF50; border-radius: 16px; background: #f0f8f0; text-align: center; transition: all 0.2s; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #4CAF50; display: block;"></i>
                                <span class="file-upload-text" style="color: #212121; font-weight: 600; font-size: 18px; display: block;">Tap to add file</span>
                                <span class="file-upload-hint" style="color: #666; font-size: 14px; display: block;">PDF, MP3, WAV, OGG, or M4A (max 100MB)</span>
                                <span class="file-name-display" id="fileNameDisplay" style="display: none; margin-top: 12px; padding: 12px 16px; background: white; border-radius: 8px; color: #4CAF50; font-size: 14px; font-weight: 600; border: 2px solid #4CAF50;"></span>
                            </div>
                        </label>
                        <style>
                            label[for="bookFile"]:active .file-upload-button {
                                border-color: #388E3C;
                                background: #e8f5e9;
                                transform: scale(0.98);
                            }
                            #bookFile:focus + .file-upload-button {
                                outline: 3px solid #4CAF50;
                                outline-offset: 2px;
                            }
                        </style>
                    </div>
                </form>
            </div>
            
            <!-- Sticky Submit Button -->
            <div style="position: sticky; bottom: 0; left: 0; right: 0; background: white; padding: 16px 20px; border-top: 1px solid #eee; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0;">
                <button type="submit" id="submitBookBtn" form="uploadBookForm" class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 18px; font-weight: 600; border-radius: 12px; border: none; cursor: pointer; touch-action: manipulation;">
                    <i class="fas fa-upload"></i> Upload Book
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Kizumu Visit Button -->
    <div class="floating-kizumu-btn" onclick="showActivitiesModal()">
        <i class="fas fa-heart"></i>
        <span>Kizumu Visit</span>
    </div>

    <!-- Activities Modal -->
    <div class="modal-overlay" id="activitiesModal" style="display: none;">
        <div class="modal-content activities-modal">
            <div class="modal-header">
                <h3><i class="fas fa-heart"></i> Important Activities</h3>
                <button class="modal-close" onclick="closeActivitiesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="activities-modal-list">
                <div class="activity-modal-item" onclick="navigateToActivity('kizumu-visit')">
                    <div class="activity-modal-icon" style="background: #E91E63;">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>Kizumu Tahfiz Charity Visit</h4>
                        <p>Support Islamic education through charity visit</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="activity-modal-item" onclick="navigateToActivity('tuition-brothers')">
                    <div class="activity-modal-icon" style="background: var(--primary-green);">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>Tuition for Brothers</h4>
                        <p>Support brothers' education and learning</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="activity-modal-item" onclick="navigateToActivity('kisilaahe')">
                    <div class="activity-modal-icon" style="background: #9C27B0;">
                        <i class="fas fa-donate"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>Donate to Kisilaahe</h4>
                        <p>Support Kisilaahe with essential items</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="activity-modal-item" onclick="navigateToActivity('activities')">
                    <div class="activity-modal-icon" style="background: #FF9800;">
                        <i class="fas fa-running"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>View All Activities</h4>
                        <p>See all community activities and events</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


