<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Set Your Password</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 40px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 24px;
    }
    p {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      color: #333;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .error {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    .error.show {
      display: block;
    }
    .success {
      background: #efe;
      color: #3c3;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    .success.show {
      display: block;
    }
    .loading {
      text-align: center;
      color: #666;
      padding: 40px;
    }
  </style>
</head>
<body>
  <div class="container" id="container">
    <div class="loading" id="loading">
      <p>Setting up your accountâ€¦</p>
    </div>

    <div id="passwordForm" style="display: none;">
      <h1>Set Your Password</h1>
      <p>Please create a password for your account.</p>
      
      <div class="error" id="error"></div>
      <div class="success" id="success"></div>

      <form id="setPasswordForm">
        <div class="form-group">
          <label for="password">Password</label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            required 
            minlength="6"
            placeholder="Enter your password (min. 6 characters)"
          />
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <input 
            type="password" 
            id="confirmPassword" 
            name="confirmPassword" 
            required 
            minlength="6"
            placeholder="Confirm your password"
          />
        </div>

        <button type="submit" id="submitBtn">Set Password</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://msojoykzcgpkikbxjgxs.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zb2pveWt6Y2dwa2lrYnhqZ3hzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NDQ3NDcsImV4cCI6MjA4MTIyMDc0N30.3DEREUsVS_gojRl_OIWo4K8bu2H_XHjjQ_F5v2JZz1Y'
    )

    const loadingEl = document.getElementById('loading')
    const passwordFormEl = document.getElementById('passwordForm')
    const errorEl = document.getElementById('error')
    const successEl = document.getElementById('success')
    const setPasswordForm = document.getElementById('setPasswordForm')
    const submitBtn = document.getElementById('submitBtn')

    // Extract code from URL
    const urlParams = new URLSearchParams(window.location.search)
    const code = urlParams.get('code')
    const type = urlParams.get('type')

    // Check if this is an invite flow
    if (!code) {
      showError('Invalid invite link. No authorization code found.')
      return
    }

    // Store the full URL for later use
    window.inviteUrl = window.location.href

    // Try to exchange code for session
    // For invites, this might succeed but user still needs to set password
    const { data: sessionData, error: sessionError } = await supabase.auth.exchangeCodeForSession(window.location.href)

    if (sessionError) {
      // If exchange fails, it might be because password is required
      // Show password form and user can set it, then we'll retry
      console.log('Session exchange error (might need password):', sessionError)
      showPasswordForm()
      return
    }

    // Exchange succeeded - check if user needs to set password
    const { data: { user }, error: userError } = await supabase.auth.getUser()
    
    if (userError || !user) {
      showError('Failed to get user information: ' + (userError?.message || 'Unknown error'))
      return
    }

    // For invite flows, always show password form to ensure password is set
    // Even if session was created, we want to confirm password is set
    if (type === 'invite' || type === 'recovery' || !user.email_confirmed_at) {
      showPasswordForm()
    } else {
      // Already authenticated with password, redirect
      window.location.href = '/'
    }

    function showPasswordForm() {
      loadingEl.style.display = 'none'
      passwordFormEl.style.display = 'block'
    }

    function showError(message) {
      loadingEl.style.display = 'none'
      errorEl.textContent = message
      errorEl.classList.add('show')
      passwordFormEl.style.display = 'block'
    }

    function showSuccess(message) {
      successEl.textContent = message
      successEl.classList.add('show')
      errorEl.classList.remove('show')
    }

    // Handle password form submission
    setPasswordForm.addEventListener('submit', async (e) => {
      e.preventDefault()
      
      const password = document.getElementById('password').value
      const confirmPassword = document.getElementById('confirmPassword').value

      // Validate passwords match
      if (password !== confirmPassword) {
        showError('Passwords do not match. Please try again.')
        return
      }

      // Validate password length
      if (password.length < 6) {
        showError('Password must be at least 6 characters long.')
        return
      }

      submitBtn.disabled = true
      submitBtn.textContent = 'Setting password...'
      errorEl.classList.remove('show')

      try {
        // Check if we already have a session from the initial exchange
        const { data: { session: currentSession } } = await supabase.auth.getSession()
        
        if (!currentSession) {
          // No session yet - try to exchange code again (in case first attempt failed)
          const { data: sessionData, error: exchangeError } = await supabase.auth.exchangeCodeForSession(window.inviteUrl || window.location.href)

          if (exchangeError) {
            throw new Error('Invalid or expired invite link. Please request a new invitation.')
          }
        }

        // Update the password for the authenticated user
        const { error: updateError } = await supabase.auth.updateUser({
          password: password
        })

        if (updateError) {
          throw updateError
        }

        // Success - redirect to home
        showSuccess('Password set successfully! Redirecting...')
        setTimeout(() => {
          window.location.href = '/'
        }, 1500)

      } catch (error) {
        console.error('Password update error:', error)
        showError('Failed to set password: ' + (error.message || 'Unknown error'))
        submitBtn.disabled = false
        submitBtn.textContent = 'Set Password'
      }
    })
  </script>
</body>
</html>

