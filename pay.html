<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#757575">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Payment - KIUMA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="nav-menu" id="navMenu">
        <div class="nav-header">
            <span class="nav-close" id="navClose"><i class="fas fa-times"></i></span>
        </div>
        <ul class="nav-list">
            <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="about.html" class="nav-link"><i class="fas fa-info-circle"></i> About</a></li>
            <li><a href="values.html" class="nav-link"><i class="fas fa-heart"></i> Values</a></li>
            <li><a href="programs.html" class="nav-link"><i class="fas fa-book"></i> Programs</a></li>
            <li><a href="activities.html" class="nav-link"><i class="fas fa-running"></i> Activities</a></li>
            <li><a href="events.html" class="nav-link"><i class="fas fa-calendar-alt"></i> Events</a></li>
            <li><a href="leadership.html" class="nav-link"><i class="fas fa-users"></i> Leadership</a></li>
            <li><a href="contact.html" class="nav-link"><i class="fas fa-phone"></i> Contact</a></li>
            <li><a href="library.html" class="nav-link"><i class="fas fa-book-open"></i> Library</a></li>
            <li><a href="media.html" class="nav-link"><i class="fas fa-photo-video"></i> Media</a></li>
            <li><a href="ask-question.html" class="nav-link"><i class="fas fa-question-circle"></i> Ask Question</a></li>
            <li><a href="join-programs.html" class="nav-link"><i class="fas fa-user-plus"></i> Join Programs</a></li>
            <li><a href="notifications.html" class="nav-link"><i class="fas fa-bell"></i> Notifications</a></li>
            <li><a href="pay.html" class="nav-link active"><i class="fas fa-credit-card"></i> Pay</a></li>
            <li><a href="join-us.html" class="nav-link"><i class="fas fa-hand-holding-heart"></i> Join Us</a></li>
        </ul>
    </nav>

    <div class="container">
        <header class="header">
            <div class="header-content">
                <button class="menu-toggle" id="menuToggle"><i class="fas fa-bars"></i></button>
                <div class="logo-container">
                    <img src="logo.png" alt="KIUMA Logo" class="header-logo" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='block';" onload="this.style.display='block'; if(this.nextElementSibling) this.nextElementSibling.style.display='none';">
                    <svg class="header-logo-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <circle cx="100" cy="100" r="95" fill="none" stroke="#4CAF50" stroke-width="4"/>
                        <path id="topArc" d="M 20,100 A 80,80 0 0,1 180,100" fill="none"/>
                        <text fill="#4CAF50" font-size="9" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="0.5">
                            <textPath href="#topArc" startOffset="50%" text-anchor="middle">KAMPALA INTERNATIONAL UNIVERSITY</textPath>
                        </text>
                        <path id="bottomArc" d="M 180,100 A 80,80 0 0,1 20,100" fill="none"/>
                        <text fill="#4CAF50" font-size="9" font-weight="bold" font-family="Arial, sans-serif" letter-spacing="0.5">
                            <textPath href="#bottomArc" startOffset="50%" text-anchor="middle">MUSLIM ASSOCIATION</textPath>
                        </text>
                        <path d="M 50,75 L 50,115 L 58,115 L 58,105 L 63,100 L 58,95 L 58,85 Z" fill="none" stroke="#4CAF50" stroke-width="2"/>
                        <circle cx="56.5" cy="100" r="2" fill="#4CAF50"/>
                        <rect x="88" y="65" width="10" height="45" fill="none" stroke="#4CAF50" stroke-width="2"/>
                        <rect x="90" y="75" width="6" height="2" fill="#4CAF50"/>
                        <rect x="90" y="85" width="6" height="2" fill="#4CAF50"/>
                        <rect x="90" y="95" width="6" height="2" fill="#4CAF50"/>
                        <polygon points="93,60 90,65 96,65" fill="#4CAF50"/>
                        <path d="M 140,92 A 12,12 0 0,1 128,92 A 10,10 0 0,0 140,92 Z" fill="#4CAF50"/>
                        <path d="M 130,88 L 131.5,92 L 136,92 L 132.5,94.5 L 134,99 L 130,96.5 L 126,99 L 127.5,94.5 L 124,92 L 128.5,92 Z" fill="#4CAF50"/>
                        <text x="100" y="145" font-size="22" font-weight="bold" fill="#4CAF50" text-anchor="middle" font-family="Arial, sans-serif" letter-spacing="2">KIUMA</text>
                    </svg>
                </div>
                <button class="notifications-btn" id="notificationsBtn">
                    <i class="fas fa-bell"></i>
                    <span class="badge" style="display: none;">0</span>
                </button>
            </div>
        </header>

        <!-- Back Button -->
        <div style="padding: 5px 20px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; margin-top: 70px;">
            <button onclick="goBack()" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: white; border: 2px solid var(--primary-green); border-radius: 8px; color: var(--primary-green); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>

        <main class="main-content">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div>
                    <h2 class="greeting">
                        <a href="about.html">KIUMA</a>
                    </h2>
                </div>
                <a href="join-us.html" class="account-icon-btn" id="accountIconBtn">
                    <i class="fas fa-user-circle" id="accountIcon"></i>
                </a>
            </section>

            <section class="page-header">
                <h2 class="page-title">Payment</h2>
            </section>

            <section class="page-content">
                <!-- Payment Type Selection -->
                <div class="payment-tabs-container">
                    <div class="payment-tab-item" data-type="semester" onclick="selectPaymentType('semester')">
                        Semester Subscription
                    </div>
                    <div class="payment-tab-item" data-type="monthly" onclick="selectPaymentType('monthly')">
                        Monthly Subscription
                    </div>
                    <div class="payment-tab-item" data-type="zakat" onclick="selectPaymentType('zakat')">
                        Zakat
                    </div>
                    <div class="payment-tab-item" data-type="charity" onclick="selectPaymentType('charity')">
                        Charity
                    </div>
                    <div class="payment-tab-item" data-type="donate" onclick="selectPaymentType('donate')">
                        Donate
                    </div>
                    <div class="payment-tab-item" data-type="kisilaahe" onclick="selectPaymentType('kisilaahe')">
                        Kisilaahe Subscription
                    </div>
                </div>

                <!-- Membership Plans Section (shown when Semester or Monthly Subscription is selected) -->
                <div id="membershipPlans" style="display: none; scroll-margin-top: 20px;">
                    <h3 class="section-title">Membership Plans</h3>
                    <div class="membership-plans-grid">
                        <!-- Undergraduate Plan -->
                        <div class="membership-plan-card">
                            <h4 class="plan-title">Undergraduate</h4>
                            <div class="plan-price">
                                <span class="price-amount">10,000</span>
                                <span class="price-currency">UGX</span>
                            </div>
                            <p class="plan-frequency">Per Semester (and above)</p>
                            <button class="plan-button" onclick="selectPlan('undergraduate', 10000)">Pay Now</button>
                        </div>

                        <!-- Postgraduate Plan -->
                        <div class="membership-plan-card">
                            <h4 class="plan-title">Postgraduate</h4>
                            <div class="plan-price">
                                <span class="price-amount">20,000</span>
                                <span class="price-currency">UGX</span>
                            </div>
                            <p class="plan-frequency">Per Semester (and above)</p>
                            <button class="plan-button" onclick="selectPlan('postgraduate', 20000)">Pay Now</button>
                        </div>

                        <!-- University Staff Plan -->
                        <div class="membership-plan-card">
                            <h4 class="plan-title">University Staff</h4>
                            <div class="plan-price">
                                <span class="price-amount">50,000</span>
                                <span class="price-currency">UGX</span>
                            </div>
                            <p class="plan-frequency">Per Semester (and above)</p>
                            <button class="plan-button" onclick="selectPlan('university-staff', 50000)">Pay Now</button>
                        </div>

                        <!-- Elders Plan -->
                        <div class="membership-plan-card">
                            <h4 class="plan-title">Elders</h4>
                            <div class="plan-price">
                                <span class="price-amount">50,000</span>
                                <span class="price-currency">UGX</span>
                            </div>
                            <p class="plan-frequency">Per Semester (and above)</p>
                            <button class="plan-button" onclick="selectPlan('elders', 50000)">Pay Now</button>
                        </div>
                    </div>
                </div>

                <!-- Payment Form (shown when a plan or other payment type is selected) -->
                <div id="paymentForm" style="display: none; scroll-margin-top: 20px;">
                    <h3 class="section-title">Complete Payment</h3>
                    
                    <div class="info-card" id="selectedPlanInfo" style="margin-bottom: 20px; display: none;">
                        <h4 id="selectedPlanName"></h4>
                        <p><strong>Amount:</strong> <span id="selectedAmount"></span> UGX</p>
                        <p><strong>Type:</strong> <span id="selectedType"></span></p>
                    </div>

                    <!-- Zakat Calculation Form -->
                    <div id="zakatForm" style="display: none;">
                        <h3 class="section-title" style="margin-bottom: 20px;">
                            <i class="fas fa-calculator"></i> Zakat Calculation Request
                        </h3>
                        <p style="color: var(--text-gray); margin-bottom: 20px; line-height: 1.6;">
                            Please provide your information for Zakat calculation. Our team will calculate your Zakat obligation and contact you.
                        </p>
                        
                        <form id="zakatCalculationForm">
                            <div class="form-group">
                                <label class="form-label">
                                    Full Name <span style="color: #F44336;">*</span>
                                </label>
                                <input type="text" class="form-input" id="zakatName" required placeholder="Enter your full name">
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Contact Number <span style="color: #F44336;">*</span>
                                </label>
                                <input type="tel" class="form-input" id="zakatContact" required placeholder="Enter your phone number">
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Location <span style="color: #F44336;">*</span>
                                </label>
                                <input type="text" class="form-input" id="zakatLocation" required placeholder="Enter your location (city, district, etc.)">
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Business Name <span style="color: #666; font-size: 12px;">(Optional)</span>
                                </label>
                                <input type="text" class="form-input" id="zakatBusiness" placeholder="Enter your business name (if applicable)">
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Date for Calculation <span style="color: #F44336;">*</span>
                                </label>
                                <input type="date" class="form-input" id="zakatDate" required>
                                <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                    Select the date for which you want Zakat calculated (usually end of lunar year)
                                </small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    Additional Information <span style="color: #666; font-size: 12px;">(Optional)</span>
                                </label>
                                <textarea class="form-input" id="zakatAdditionalInfo" rows="4" placeholder="Any additional information about your assets, income, or specific questions about Zakat calculation"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, var(--primary-green), var(--dark-green)); padding: 15px; font-size: 18px; font-weight: 600;">
                                <i class="fab fa-whatsapp"></i> Submit Zakat Calculation Request
                            </button>

                            <div class="success-message" id="zakatSuccess" style="display: none; margin-top: 20px;">
                                <i class="fas fa-check-circle"></i> WhatsApp will open with your Zakat calculation request. Our team will calculate your Zakat and contact you soon.
                            </div>
                        </form>
                    </div>

                    <!-- Unified Payment Form (for ALL payment types except Zakat) -->
                    <div id="unifiedPaymentForm" style="display: none;">
                        <h3 class="section-title" style="margin-bottom: 20px;">Payment Details</h3>

                        <!-- Name Input (Autofill, Optional) -->
                        <div class="form-group">
                            <label class="form-label">Name <span style="color: #666; font-size: 12px;">(Optional)</span></label>
                            <input type="text" class="form-input" id="paymentName" placeholder="Enter your name (will auto-fill if logged in)">
                        </div>

                        <!-- Registration Number (Optional) -->
                        <div class="form-group">
                            <label class="form-label">Registration Number <span style="color: #666; font-size: 12px;">(Optional)</span></label>
                            <input type="text" class="form-input" id="paymentRegNumber" placeholder="Enter your registration number (if applicable)">
                        </div>

                        <!-- Amount Input (Required for non-subscriptions, shown for subscriptions as info) -->
                        <div class="form-group" id="paymentAmountGroup">
                            <label class="form-label">Amount (UGX) <span id="amountRequired" style="color: #F44336;">*</span></label>
                            <input type="number" class="form-input" id="paymentAmount" placeholder="Enter amount" min="1" max="100000000" step="1" oninput="formatAmount(this)">
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">Minimum: 1 UGX | Maximum: 100,000,000 UGX</small>
                        </div>

                        <!-- Payment Method Selection (Required) -->
                        <div class="form-group">
                            <label class="form-label">Payment Method <span style="color: #F44336;">*</span></label>
                            <select class="form-input" id="paymentMethod" required onchange="handlePaymentMethodChange()">
                                <option value="">Select payment method</option>
                                <option value="mtn">MTN Mobile Money</option>
                                <option value="airtel">Airtel Money</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="pesapal">Pesapal (Online Payment)</option>
                                <option value="other">Other Payment Methods</option>
                            </select>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">Select the method you will use to make payment</small>
                            
                            <!-- Other Payment Methods Dropdown (shown when "Other Payment Methods" is selected) -->
                            <div id="otherPaymentMethods" style="display: none; margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <label class="form-label" style="margin-bottom: 10px; font-size: 14px; font-weight: 600;">Select Alternative Payment Method:</label>
                                <select class="form-input" id="otherPaymentMethodSelect" onchange="handleOtherPaymentMethodChange()">
                                    <option value="">Choose an alternative method</option>
                                    <option value="pesapal">Pesapal (Online Payment)</option>
                                </select>
                                <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">Additional payment options</small>
                            </div>
                        </div>

                        <!-- Pesapal Payment Button (shown when Pesapal is selected) -->
                        <div class="form-group" id="pesapalPaymentButton" style="display: none; margin-top: 20px;">
                            <button type="button" class="btn btn-primary" id="payWithPesapalBtn" onclick="processPesapalPayment()" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 15px; font-size: 16px; font-weight: 600;">
                                <i class="fas fa-credit-card"></i> Pay with Pesapal
                            </button>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block; text-align: center;">Secure online payment via Pesapal</small>
                        </div>

                        <!-- Payment Reason (Required for non-subscriptions, hidden for subscriptions) -->
                        <div class="form-group" id="paymentReasonGroup" style="display: none;">
                            <label class="form-label">Payment Reason <span style="color: #F44336;">*</span></label>
                            <select class="form-input" id="paymentReason" required>
                                <option value="">Select payment reason</option>
                                <option value="general-donation">General Donation</option>
                                <option value="iftar">Iftar</option>
                                <option value="bananas">Bananas</option>
                                <option value="mosque-building-fund">Mosque Building Fund</option>
                                <option value="kizumu-tahfiz-charity-visit">Kizumu Tahfiz Charity Visit</option>
                                <option value="tuition-for-brothers">Tuition for Brothers</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Payment Notes (Optional) -->
                        <div class="form-group">
                            <label class="form-label">Notes <span style="color: #666; font-size: 12px;">(Optional)</span></label>
                            <textarea class="form-input" id="paymentNotes" rows="3" placeholder="Add any notes about your payment (e.g., 'I want you to use this for bananas this week')"></textarea>
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">Any additional information about your payment</small>
                        </div>

                        <!-- WhatsApp Link to Amir (for ALL payment types) -->
                        <div class="form-group" style="margin-top: 20px;">
                            <button type="button" class="btn btn-primary" id="contactAmirBtn" onclick="sendPaymentToAmir()" style="width: 100%; background: #25D366; border: none; padding: 15px; font-size: 16px; font-weight: 600;">
                                <i class="fab fa-whatsapp"></i> Send Payment Details to Amir
                            </button>
                        </div>
                    </div>

                    <!-- Subscription Form (for Semester/Monthly Subscriptions - Legacy fields) -->
                    <div id="subscriptionForm" style="display: none;">
                        <!-- Course (for Students) -->
                        <div class="form-group" id="courseGroup" style="display: none;">
                            <label class="form-label">Course <span style="color: #F44336;">*</span></label>
                            <input type="text" class="form-input" id="course" placeholder="Enter your course" required>
                        </div>

                        <!-- Faculty/Department (for Lecturers) -->
                        <div class="form-group" id="facultyGroup" style="display: none;">
                            <label class="form-label">Faculty/Department <span style="color: #F44336;">*</span></label>
                            <input type="text" class="form-input" id="faculty" placeholder="Enter your faculty or department" required>
                        </div>
                    </div>

                    <!-- Payment Reference Field -->
                    <div class="form-group" id="paymentReferenceGroup" style="display: none;">
                        <label class="form-label">Payment Reference <span style="color: #F44336;">*</span> <span style="color: #666; font-size: 12px;">(Use this when making payment)</span></label>
                        <input type="text" class="form-input" id="paymentReference" placeholder="Auto-generated" readonly style="background: #f5f5f5;">
                        <small style="color: #F44336; font-size: 12px; margin-top: 5px; display: block; font-weight: 600;">⚠️ CRUCIAL: Use this reference when making payment</small>
                    </div>

                    <!-- Notice about Amir Daawa Communication -->
                    <div class="info-card" id="amirDaawaNotice" style="display: none; background: #E8F5E9; border-left: 4px solid #4CAF50; margin-top: 20px;">
                        <h4 style="color: #2E7D32; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> Message Sent Successfully
                        </h4>
                        <p style="color: #1B5E20; margin: 0; font-weight: 500;">
                            The Amir Daawa will communicate with you soon regarding your payment. Please wait for their response.
                        </p>
                    </div>

                    <!-- Payment Methods -->
                    <div class="form-group">
                        <label class="form-label" style="margin-bottom: 15px; font-size: 18px; font-weight: 600;">Recommended Payment Methods</label>
                        
                        <!-- MTN Mobile Money -->
                        <div class="payment-account-card">
                            <div class="payment-account-header">
                                <i class="fab fa-mobile-alt" style="color: #FFCC00;"></i>
                                <h4>MTN Mobile Money</h4>
                            </div>
                            <div class="payment-account-details">
                                <div class="account-detail-row">
                                    <span class="account-label">Account Name:</span>
                                    <span class="account-value">Okullo Abdulsalam</span>
                                    <button class="copy-btn" onclick="copyToClipboard('Okullo Abdulsalam')" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="account-detail-row">
                                    <span class="account-label">Phone Number:</span>
                                    <span class="account-value">0787749111</span>
                                    <button class="copy-btn" onclick="copyToClipboard('0787749111')" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="payment-reference-note" style="background: #FFEBEE; border: 2px solid #F44336; border-radius: 8px; padding: 12px; margin-top: 10px;">
                                    <strong style="color: #F44336; font-size: 16px; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-exclamation-triangle"></i> CRUCIAL: Payment Reference
                                    </strong>
                                    <span style="color: #C62828; font-weight: 600; font-size: 14px;">⚠️ Use your name or student ID as payment reference</span>
                                </div>
                            </div>
                        </div>

                        <!-- Airtel Mobile Money -->
                        <div class="payment-account-card">
                            <div class="payment-account-header">
                                <i class="fas fa-mobile-alt" style="color: #E60012;"></i>
                                <h4>Airtel Money</h4>
                            </div>
                            <div class="payment-account-details">
                                <div class="account-detail-row">
                                    <span class="account-label">Account Name:</span>
                                    <span class="account-value">Okullo Abdulsalam</span>
                                    <button class="copy-btn" onclick="copyToClipboard('Okullo Abdulsalam')" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="account-detail-row">
                                    <span class="account-label">Phone Number:</span>
                                    <span class="account-value">0703268522</span>
                                    <button class="copy-btn" onclick="copyToClipboard('0703268522')" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="payment-reference-note" style="background: #FFEBEE; border: 2px solid #F44336; border-radius: 8px; padding: 12px; margin-top: 10px;">
                                    <strong style="color: #F44336; font-size: 16px; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-exclamation-triangle"></i> CRUCIAL: Payment Reference
                                    </strong>
                                    <span style="color: #C62828; font-weight: 600; font-size: 14px;">⚠️ Use your name or student ID as payment reference</span>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Account -->
                        <div class="payment-account-card">
                            <div class="payment-account-header">
                                <i class="fas fa-university" style="color: var(--primary-green);"></i>
                                <h4>Bank Account</h4>
                            </div>
                            <div class="payment-account-details">
                                <div class="account-detail-row">
                                    <span class="account-label">Bank Name:</span>
                                    <span class="account-value">Centenary Bank</span>
                                    <button class="copy-btn" onclick="copyToClipboard('Centenary Bank')" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="account-detail-row">
                                    <span class="account-label">Account Name:</span>
                                    <span class="account-value">KIUMA Finance</span>
                                    <button class="copy-btn" onclick="copyToClipboard('KIUMA Finance')" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="account-detail-row">
                                    <span class="account-label">Account Number:</span>
                                    <span class="account-value">4592430101469919</span>
                                    <button class="copy-btn" onclick="copyToClipboard('4592430101469919')" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="account-detail-row">
                                    <span class="account-label">Branch:</span>
                                    <span class="account-value">Ishaka Branch</span>
                                    <button class="copy-btn" onclick="copyToClipboard('Ishaka Branch')" title="Copy">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="payment-reference-note" style="background: #FFEBEE; border: 2px solid #F44336; border-radius: 8px; padding: 12px; margin-top: 10px;">
                                    <strong style="color: #F44336; font-size: 16px; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-exclamation-triangle"></i> CRUCIAL: Payment Reference
                                    </strong>
                                    <span style="color: #C62828; font-weight: 600; font-size: 14px;">⚠️ Use your name or student ID as payment reference</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WhatsApp Contact Section -->
                    <div class="whatsapp-contact-card">
                        <div class="whatsapp-icon-wrapper">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="whatsapp-content">
                            <h4>Contact Finance Minister</h4>
                            <p>Have questions about payment? Contact our Finance Minister via WhatsApp before or after making your deposit.</p>
                            <a href="javascript:void(0)" onclick="if(typeof window.openWhatsApp==='function'){window.openWhatsApp('256703268522');}else{window.location.href='https://wa.me/256703268522';}" class="whatsapp-button" style="cursor: pointer;">
                                <i class="fab fa-whatsapp"></i> Message Finance Minister
                            </a>
                            <p style="font-size: 12px; color: rgba(255, 255, 255, 0.8); margin: 8px 0 0 0;">
                                <small>WhatsApp: 0703268522</small>
                            </p>
                        </div>
                    </div>

                    <!-- Payment Instructions -->
                    <div class="info-card" style="background: #FFF3E0; margin-top: 20px;">
                        <h4 style="color: #F57C00; margin-bottom: 10px;">
                            <i class="fas fa-info-circle"></i> Payment Instructions
                        </h4>
                        <ol style="margin: 0; padding-left: 20px; color: var(--dark-gray); line-height: 1.8;">
                            <li>Select your payment type and amount above</li>
                            <li>Choose your preferred payment method (MTN, Airtel, or Bank)</li>
                            <li>Copy the account details and make your payment</li>
                            <li style="color: #F44336; font-weight: 600;"><strong>⚠️ CRUCIAL:</strong> Use your name or student ID as the payment reference</li>
                            <li>Contact the Finance Minister via WhatsApp to confirm your payment</li>
                        </ol>
                    </div>

                    <!-- Make Payment Button -->
                    <button class="btn btn-primary" onclick="processPayment()">
                        <i class="fas fa-lock"></i> Make Payment
                    </button>

                    <!-- Security Notice -->
                    <div class="info-card" style="margin-top: 20px; background: #E8F5E9;">
                        <p style="font-size: 14px; color: var(--dark-green); margin: 0;">
                            <i class="fas fa-shield-alt"></i> Your payment is secure and encrypted. We use industry-standard security measures to protect your information.
                        </p>
                    </div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav">
            <a href="index.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
            <a href="programs.html" class="nav-item"><i class="fas fa-book"></i><span>Programs</span></a>
            <a href="events.html" class="nav-item"><i class="fas fa-calendar"></i><span>Events</span></a>
            <a href="pay.html" class="nav-item active"><i class="fas fa-credit-card"></i><span>Pay</span></a>
            <a href="join-us.html" class="nav-item"><i class="fas fa-user-plus"></i><span>Join</span></a>
        </nav>
    </div>

    <!-- Service Worker Registration (for offline functionality) -->
    <script src="js/register-service-worker.js"></script>
    
    <!-- Payment Integration - Choose ONE: Vercel, Railway, or Firebase Functions -->
    
    <!-- Option 1: Vercel Serverless Function (EASIEST - Free, No backend needed) -->
    <script>
        // Set your Vercel API URL here (get from Vercel dashboard after deployment)
        window.VERCEL_API_URL = 'https://your-app.vercel.app'; // UPDATE THIS with your Vercel URL
    </script>
    <script src="public/payment-vercel.js"></script>
    
    <!-- Option 2: Railway Backend (Free tier available) -->
    <!-- Uncomment below and comment out Vercel option above if using Railway -->
    <!--
    <script>
        window.RAILWAY_API_URL = 'https://your-app.railway.app';
    </script>
    <script src="public/payment-railway.js"></script>
    -->
    
    <!-- Option 3: Firebase Functions (Requires Blaze plan) -->
    <!-- Uncomment below if using Firebase Functions -->
    <!--
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="fcm-config.js"></script>
    <script src="public/payment.js"></script>
    <script>
        if (typeof firebase !== 'undefined' && typeof initializeFirebaseApp === 'function') {
            initializeFirebaseApp();
        }
    </script>
    -->
    
    <script src="script.js"></script>
    <script src="update-navigation.js"></script>
    <script>
        let selectedPaymentType = '';
        let selectedPlan = null;
        let selectedAmount = 0;

        // Check URL parameters for Kizumu visit
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const type = urlParams.get('type');
            const donation = urlParams.get('donation');
            
            if (type === 'charity' && donation) {
                selectPaymentType('charity');
                setTimeout(() => {
                    const donationTypeEl = document.getElementById('donationType');
                    if (donationTypeEl) {
                        donationTypeEl.value = donation;
                    }
                }, 300);
            }
        });

        function selectPaymentType(type) {
            selectedPaymentType = type;
            
            // Update UI
            document.querySelectorAll('.payment-tab-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            // Show/hide sections
            const membershipPlans = document.getElementById('membershipPlans');
            const paymentForm = document.getElementById('paymentForm');
            const customAmountGroup = document.getElementById('customAmountGroup');
            const selectedPlanInfo = document.getElementById('selectedPlanInfo');

            if (type === 'semester' || type === 'monthly') {
                membershipPlans.style.display = 'block';
                paymentForm.style.display = 'none';
                selectedPlan = null;
                
                // Scroll to membership plans section
                setTimeout(() => {
                    membershipPlans.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else if (type === 'zakat') {
                // Special Zakat form - ONLY show Zakat calculation form
                membershipPlans.style.display = 'none';
                paymentForm.style.display = 'block';
                const unifiedForm = document.getElementById('unifiedPaymentForm');
                const zakatForm = document.getElementById('zakatForm');
                if (unifiedForm) unifiedForm.style.display = 'none';
                if (zakatForm) zakatForm.style.display = 'block';
                selectedPlanInfo.style.display = 'none';
                document.getElementById('amirDaawaNotice').style.display = 'none';
                
                // Hide payment methods section for Zakat
                const recommendedMethods = document.getElementById('recommendedPaymentMethods');
                if (recommendedMethods) recommendedMethods.style.display = 'none';
                
                // Scroll to zakat form
                setTimeout(() => {
                    paymentForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else {
                // For all other payment types (charity, donate, kisilaahe)
                membershipPlans.style.display = 'none';
                paymentForm.style.display = 'block';
                const unifiedForm = document.getElementById('unifiedPaymentForm');
                const zakatForm = document.getElementById('zakatForm');
                if (unifiedForm) unifiedForm.style.display = 'block';
                if (zakatForm) zakatForm.style.display = 'none';
                selectedPlanInfo.style.display = 'none';
                document.getElementById('amirDaawaNotice').style.display = 'none';
                
                // Show payment methods section for non-Zakat payments
                const recommendedMethods = document.getElementById('recommendedPaymentMethods');
                if (recommendedMethods) recommendedMethods.style.display = 'block';
                
                // Show payment reason (required for non-subscriptions)
                const paymentReasonGroup = document.getElementById('paymentReasonGroup');
                const paymentReason = document.getElementById('paymentReason');
                if (paymentReasonGroup) paymentReasonGroup.style.display = 'block';
                if (paymentReason) paymentReason.required = true;
                
                // Amount is required
                const amountInput = document.getElementById('paymentAmount');
                const amountRequired = document.getElementById('amountRequired');
                if (amountInput) {
                    amountInput.required = true;
                    amountInput.readOnly = false;
                    amountInput.style.background = '';
                }
                if (amountRequired) amountRequired.style.display = 'inline';
                
                // Set default amount for Kisilaahe
                if (type === 'kisilaahe' && amountInput) {
                    amountInput.value = '1500000';
                    selectedAmount = 1500000;
                    selectedPlan = 'kisilaahe';
                }
                
                // Autofill name if user is logged in
                autofillPaymentName();
                
                // Show payment reference
                document.getElementById('paymentReferenceGroup').style.display = 'block';
                generatePaymentReference();
                
                // Scroll to payment form
                setTimeout(() => {
                    paymentForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }
        
        // Generate payment reference
        function generatePaymentReference() {
            const userData = JSON.parse(localStorage.getItem('userData') || 'null');
            const userName = userData ? (userData.name || userData.firstName || 'USER') : 'USER';
            const timestamp = Date.now().toString().slice(-6);
            const reference = `${userName.toUpperCase().replace(/\s/g, '')}-${timestamp}`;
            
            const refInput = document.getElementById('paymentReference');
            if (refInput) {
                refInput.value = reference;
            }
        }
        
        // Format amount input
        function formatAmount(input) {
            // Remove any non-numeric characters
            let value = input.value.replace(/[^\d]/g, '');
            
            // Validate min/max
            const min = parseInt(input.getAttribute('min')) || 1;
            const max = parseInt(input.getAttribute('max')) || 100000000;
            
            if (value && parseInt(value) < min) {
                value = min.toString();
            }
            if (value && parseInt(value) > max) {
                value = max.toString();
            }
            
            input.value = value;
        }
        
        // Autofill payment name from userData
        function autofillPaymentName() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || 'null');
                const nameInput = document.getElementById('paymentName');
                if (userData && nameInput) {
                    const userName = userData.name || userData.firstName || userData.email || '';
                    if (userName) {
                        nameInput.value = userName;
                    }
                }
            } catch (error) {
                console.error('Error autofilling name:', error);
            }
        }

        function selectPlan(planName, amount) {
            selectedPlan = planName;
            selectedAmount = amount;

            // Show payment form
            document.getElementById('membershipPlans').style.display = 'none';
            document.getElementById('paymentForm').style.display = 'block';
            document.getElementById('unifiedPaymentForm').style.display = 'block';
            document.getElementById('selectedPlanInfo').style.display = 'block';
            document.getElementById('subscriptionForm').style.display = 'block';
            
            // Hide payment reason for subscriptions
            document.getElementById('paymentReasonGroup').style.display = 'none';
            document.getElementById('paymentReason').required = false;
            
            // Set amount from plan (read-only for subscriptions)
            const amountInput = document.getElementById('paymentAmount');
            const amountRequired = document.getElementById('amountRequired');
            if (amountInput) {
                amountInput.value = amount;
                amountInput.required = false;
                amountInput.readOnly = true;
                amountInput.style.background = '#f5f5f5';
            }
            if (amountRequired) {
                amountRequired.style.display = 'none';
            }
            
            // Autofill name if user is logged in
            autofillPaymentName();
            
            // Show payment reference and method selection
            document.getElementById('paymentReferenceGroup').style.display = 'block';
            generatePaymentReference();

            // Update plan info
            const planNames = {
                'undergraduate': 'Undergraduate Plan',
                'postgraduate': 'Postgraduate Plan',
                'university-staff': 'University Staff Plan',
                'elders': 'Elders Plan'
            };
            document.getElementById('selectedPlanName').textContent = planNames[planName];
            document.getElementById('selectedAmount').textContent = amount.toLocaleString();
            document.getElementById('selectedType').textContent = selectedPaymentType === 'semester' ? 'Semester Subscription' : 'Monthly Subscription';
            
            // Show/hide fields based on plan type
            const regNumberGroup = document.getElementById('regNumberGroup');
            const courseGroup = document.getElementById('courseGroup');
            const facultyGroup = document.getElementById('facultyGroup');
            
            // Clear previous values
            document.getElementById('subscriptionName').value = '';
            document.getElementById('regNumber').value = '';
            document.getElementById('course').value = '';
            document.getElementById('faculty').value = '';
            
            // Check if student plan (undergraduate, postgraduate) or lecturer plan (university-staff)
            if (planName === 'undergraduate' || planName === 'postgraduate') {
                // Student fields
                regNumberGroup.style.display = 'block';
                courseGroup.style.display = 'block';
                facultyGroup.style.display = 'none';
                document.getElementById('regNumber').required = true;
                document.getElementById('course').required = true;
                document.getElementById('faculty').required = false;
            } else if (planName === 'university-staff') {
                // Lecturer fields
                regNumberGroup.style.display = 'none';
                courseGroup.style.display = 'none';
                facultyGroup.style.display = 'block';
                document.getElementById('regNumber').required = false;
                document.getElementById('course').required = false;
                document.getElementById('faculty').required = true;
            } else {
                // Elders or other plans - no special fields
                regNumberGroup.style.display = 'none';
                courseGroup.style.display = 'none';
                facultyGroup.style.display = 'none';
                document.getElementById('regNumber').required = false;
                document.getElementById('course').required = false;
                document.getElementById('faculty').required = false;
            }
            
            // Pre-fill name from user data if available
            const userData = JSON.parse(localStorage.getItem('userData') || 'null');
            if (userData && (userData.name || userData.firstName)) {
                document.getElementById('subscriptionName').value = userData.name || userData.firstName;
            }
            
            // Scroll to payment form
            setTimeout(() => {
                document.getElementById('paymentForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        // Mobile-friendly alert replacement
        function showMobileAlert(message, title = 'Notice') {
            // Create custom modal instead of browser alert
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; max-width: 400px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 20px;">${title}</h3>
                    <p style="margin: 0 0 20px 0; color: #555; line-height: 1.6; white-space: pre-line;">${message}</p>
                    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                            style="width: 100%; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto-remove on outside click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function processPayment() {
            if (!selectedPaymentType) {
                showMobileAlert('Please select a payment type first', 'Payment Type Required');
                return;
            }
            
            // Validate payment method selection
            const paymentMethodGroup = document.getElementById('paymentMethodGroup');
            if (paymentMethodGroup && paymentMethodGroup.style.display !== 'none') {
                const selectedMethod = document.getElementById('selectedPaymentMethod').value;
                if (!selectedMethod) {
                    showMobileAlert('Please select a payment method', 'Payment Method Required');
                    document.getElementById('selectedPaymentMethod').focus();
                    return;
                }
            }
            
            // Validate payment reference
            const paymentReference = document.getElementById('paymentReference').value;
            if (!paymentReference) {
                showMobileAlert('Payment reference is missing. Please refresh the page.', 'Error');
                return;
            }

            // For subscription payments, validate subscription form
            if (selectedPaymentType === 'semester' || selectedPaymentType === 'monthly') {
                const subscriptionForm = document.getElementById('subscriptionForm');
                if (subscriptionForm && subscriptionForm.style.display !== 'none') {
                    const name = document.getElementById('subscriptionName').value;
                    
                    if (!name || name.trim() === '') {
                        showMobileAlert('Please enter your full name', 'Name Required');
                        document.getElementById('subscriptionName').focus();
                        return;
                    }
                    
                    // Check if student plan - validate reg number and course
                    if (selectedPlan === 'undergraduate' || selectedPlan === 'postgraduate') {
                        const regNumber = document.getElementById('regNumber').value;
                        const course = document.getElementById('course').value;
                        
                        if (!regNumber || regNumber.trim() === '') {
                            showMobileAlert('Please enter your registration number', 'Registration Number Required');
                            document.getElementById('regNumber').focus();
                            return;
                        }
                        
                        if (!course || course.trim() === '') {
                            showMobileAlert('Please enter your course', 'Course Required');
                            document.getElementById('course').focus();
                            return;
                        }
                    }
                    
                    // Check if lecturer plan - validate faculty
                    if (selectedPlan === 'university-staff') {
                        const faculty = document.getElementById('faculty').value;
                        
                        if (!faculty || faculty.trim() === '') {
                            showMobileAlert('Please enter your faculty or department', 'Faculty Required');
                            document.getElementById('faculty').focus();
                            return;
                        }
                    }
                }
            }

            let amount = selectedAmount;
            if (!amount) {
                amount = document.getElementById('amount').value;
                if (!amount || amount <= 0) {
                    showMobileAlert('Please enter a valid amount (minimum 1 UGX)', 'Invalid Amount');
                    document.getElementById('amount').focus();
                    return;
                }
            }
            
            // Get payment method
            const paymentMethod = document.getElementById('selectedPaymentMethod')?.value || 'not-selected';
            const methodNames = {
                'mtn': 'MTN Mobile Money',
                'airtel': 'Airtel Money',
                'bank': 'Bank Transfer',
                'not-selected': 'Not Selected'
            };

            // Payment confirmation
            const paymentTypeNames = {
                'semester': 'Semester Subscription',
                'monthly': 'Monthly Subscription',
                'zakat': 'Zakat',
                'charity': 'Charity',
                'donate': 'Donation',
                'kisilaahe': 'Kisilaahe Subscription'
            };

            // Generate payment ID
            const paymentId = 'PAY-' + Date.now().toString().slice(-8);
            
            // Build payment summary
            let summary = {
                id: paymentId,
                type: paymentTypeNames[selectedPaymentType],
                amount: parseInt(amount),
                reference: paymentReference,
                method: methodNames[paymentMethod],
                timestamp: new Date().toISOString(),
                status: 'pending'
            };
            
            // Add subscription details if applicable
            if (selectedPaymentType === 'semester' || selectedPaymentType === 'monthly') {
                const name = document.getElementById('subscriptionName').value;
                summary.name = name;
                
                if (selectedPlan === 'undergraduate' || selectedPlan === 'postgraduate') {
                    const regNumber = document.getElementById('regNumber').value;
                    const course = document.getElementById('course').value;
                    summary.regNumber = regNumber;
                    summary.course = course;
                } else if (selectedPlan === 'university-staff') {
                    const faculty = document.getElementById('faculty').value;
                    summary.faculty = faculty;
                }
            } else {
                // For other payment types
                const donationType = document.getElementById('donationType')?.value;
                const reason = document.getElementById('donationReason')?.value;
                if (donationType) summary.donationType = donationType;
                if (reason) summary.reason = reason;
            }
            
            // Save payment to localStorage
            try {
                let payments = JSON.parse(localStorage.getItem('paymentHistory') || '[]');
                payments.unshift(summary);
                // Keep only last 50 payments
                if (payments.length > 50) payments = payments.slice(0, 50);
                localStorage.setItem('paymentHistory', JSON.stringify(payments));
            } catch (e) {
                console.log('Could not save payment history:', e);
            }
            
            // Show payment confirmation modal
            showPaymentConfirmation(summary);
        }
        
        // Show payment confirmation modal
        function showPaymentConfirmation(payment) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; justify-content: center; align-items: center; padding: 20px; overflow-y: auto;';
            
            const methodDetails = {
                'mtn': { name: 'MTN Mobile Money', number: '0787749111', account: 'Okullo Abdulsalam' },
                'airtel': { name: 'Airtel Money', number: '0703268522', account: 'Okullo Abdulsalam' },
                'bank': { name: 'Bank Transfer', number: '4592430101469919', account: 'KIUMA Finance - Centenary Bank' }
            };
            
            const selectedMethod = methodDetails[payment.method.toLowerCase().replace(' ', '-')] || methodDetails.mtn;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; max-width: 500px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 64px; margin-bottom: 10px;">✅</div>
                        <h2 style="margin: 0; color: #2c3e50;">Payment Ready</h2>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Payment ID: ${payment.id}</p>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                        <div style="margin-bottom: 10px;"><strong>Amount:</strong> ${payment.amount.toLocaleString()} UGX</div>
                        <div style="margin-bottom: 10px;"><strong>Type:</strong> ${payment.type}</div>
                        <div style="margin-bottom: 10px;"><strong>Payment Method:</strong> ${payment.method}</div>
                        <div style="margin-bottom: 10px;"><strong>Reference:</strong> <code style="background: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; color: #F44336;">${payment.reference}</code></div>
                        ${payment.name ? `<div style="margin-bottom: 10px;"><strong>Name:</strong> ${payment.name}</div>` : ''}
                        ${payment.regNumber ? `<div style="margin-bottom: 10px;"><strong>Reg Number:</strong> ${payment.regNumber}</div>` : ''}
                    </div>
                    
                    <div style="background: #FFEBEE; border-left: 4px solid #F44336; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                        <strong style="color: #F44336; display: block; margin-bottom: 5px;">⚠️ IMPORTANT:</strong>
                        <p style="margin: 0; color: #C62828; font-size: 14px; line-height: 1.6;">
                            Use payment reference <strong>${payment.reference}</strong> when making payment via ${selectedMethod.name}.
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                style="flex: 1; padding: 12px; background: #95a5a6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                        <button onclick="window.print(); this.closest('div[style*=\"position: fixed\"]').remove();" 
                                style="flex: 1; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            Print Receipt
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto-remove on outside click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                // Show feedback
                const btn = event.target.closest('.copy-btn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.style.background = 'var(--primary-green)';
                btn.style.color = 'white';
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }).catch(function(err) {
                alert('Failed to copy. Please copy manually: ' + text);
            });
        }

        window.contactAmir = function() {
            // Get form values
            const paymentType = selectedPaymentType;
            const amount = document.getElementById('amount').value;
            const donationType = document.getElementById('donationType').value;
            const reason = document.getElementById('donationReason').value;

            // Validate required fields
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            if (!donationType) {
                alert('Please select a payment reason');
                return;
            }

            if (!reason || reason.trim() === '') {
                alert('Please provide a reason for your payment');
                return;
            }

            // Get payment type name
            const typeNames = {
                'zakat': 'Zakat',
                'charity': 'Charity',
                'donate': 'Donation',
                'kisilaahe': 'Kisilaahe Subscription'
            };

            // Get donation type name
            const donationTypeNames = {
                'general-donation': 'General Donation',
                'iftar': 'Iftar',
                'bananas': 'Bananas',
                'mosque-building-fund': 'Mosque Building Fund',
                'kizumu-tahfiz-charity-visit': 'Kizumu Tahfiz Charity Visit',
                'tuition-for-brothers': 'Tuition for Brothers',
                'other': 'Other'
            };

            // Get user name if available
            const userData = JSON.parse(localStorage.getItem('userData') || 'null');
            const userName = userData ? (userData.name || userData.firstName || userData.email || 'User') : 'User';

            // Create WhatsApp message
            const message = `Assalam Alaikum Amir,

I would like to make a payment:

Payment Type: ${typeNames[paymentType] || paymentType}
Payment Reason: ${donationTypeNames[donationType] || donationType}
Amount: ${parseInt(amount).toLocaleString()} UGX
Reason: ${reason}
Name: ${userName}

Please confirm the payment details and provide further instructions.

Jazakallahu Khairan.`;

            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);

            // Open WhatsApp (mobile-friendly)
            if (typeof window.openWhatsApp === 'function') {
                window.openWhatsApp('256768829144', message);
            } else {
                // Fallback for older browsers
            const whatsappLink = `https://wa.me/256768829144?text=${encodedMessage}`;
                window.location.href = whatsappLink;
            }

            // Show notice about Amir Daawa communication
            document.getElementById('amirDaawaNotice').style.display = 'block';
            
            // Scroll to notice
            setTimeout(() => {
                document.getElementById('amirDaawaNotice').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 500);
        };

        window.contactAmirFinance = function() {
            // Validate that a plan is selected
            if (!selectedPlan || !selectedAmount) {
                alert('Please select a subscription plan first');
                return;
            }

            // Get form values
            const name = document.getElementById('subscriptionName').value;
            
            if (!name || name.trim() === '') {
                alert('Please enter your full name');
                document.getElementById('subscriptionName').focus();
                return;
            }

            // Get plan name
            const planNames = {
                'undergraduate': 'Undergraduate Plan',
                'postgraduate': 'Postgraduate Plan',
                'university-staff': 'University Staff Plan',
                'elders': 'Elders Plan'
            };
            const planName = planNames[selectedPlan] || selectedPlan;

            // Get payment type name
            const paymentTypeName = selectedPaymentType === 'semester' ? 'Semester Subscription' : 'Monthly Subscription';

            // Build message with plan and amount
            let message = `Assalam Alaikum Amir Finance,\n\n`;
            message += `I would like to make a subscription payment:\n\n`;
            message += `Plan: ${planName}\n`;
            message += `Type: ${paymentTypeName}\n`;
            message += `Amount: ${selectedAmount.toLocaleString()} UGX\n`;
            message += `Name: ${name}\n`;

            // Add student-specific fields
            if (selectedPlan === 'undergraduate' || selectedPlan === 'postgraduate') {
                const regNumber = document.getElementById('regNumber').value;
                const course = document.getElementById('course').value;
                
                if (regNumber && regNumber.trim() !== '') {
                    message += `Registration Number: ${regNumber}\n`;
                }
                if (course && course.trim() !== '') {
                    message += `Course: ${course}\n`;
                }
            }

            // Add lecturer-specific fields
            if (selectedPlan === 'university-staff') {
                const faculty = document.getElementById('faculty').value;
                if (faculty && faculty.trim() !== '') {
                    message += `Faculty/Department: ${faculty}\n`;
                }
            }

            message += `\nPlease confirm the payment details and provide further instructions.\n\nJazakallahu Khairan.`;

            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);

            // Open WhatsApp (mobile-friendly)
            if (typeof window.openWhatsApp === 'function') {
                window.openWhatsApp('256703268522', message);
            } else {
                // Fallback for older browsers
                const whatsappLink = `https://wa.me/256703268522?text=${encodedMessage}`;
                window.location.href = whatsappLink;
            }
        };

        // Unified function to send payment details to Amir (for ALL payment types)
        window.sendPaymentToAmir = function() {
            // Get payment type
            const paymentType = selectedPaymentType;
            const isSubscription = (paymentType === 'semester' || paymentType === 'monthly');
            
            // Get unified form values
            const name = document.getElementById('paymentName')?.value?.trim() || '';
            const regNumber = document.getElementById('paymentRegNumber')?.value?.trim() || '';
            const amount = isSubscription ? selectedAmount : (document.getElementById('paymentAmount')?.value || '');
            const paymentMethod = document.getElementById('paymentMethod')?.value || '';
            const paymentReason = document.getElementById('paymentReason')?.value || '';
            const notes = document.getElementById('paymentNotes')?.value?.trim() || '';
            
            // Validate required fields
            if (!isSubscription) {
                // For non-subscriptions, amount and payment reason are required
                if (!amount || amount <= 0) {
                    alert('Please enter a valid amount');
                    document.getElementById('paymentAmount')?.focus();
                    return;
                }
                
                if (!paymentReason) {
                    alert('Please select a payment reason');
                    document.getElementById('paymentReason')?.focus();
                    return;
                }
            }
            
            if (!paymentMethod) {
                alert('Please select a payment method');
                document.getElementById('paymentMethod')?.focus();
                return;
            }
            
            // Get payment type names
            const typeNames = {
                'semester': 'Semester Subscription',
                'monthly': 'Monthly Subscription',
                'zakat': 'Zakat',
                'charity': 'Charity',
                'donate': 'Donation',
                'kisilaahe': 'Kisilaahe Subscription'
            };
            
            // Get payment reason names
            const reasonNames = {
                'general-donation': 'General Donation',
                'iftar': 'Iftar',
                'bananas': 'Bananas',
                'mosque-building-fund': 'Mosque Building Fund',
                'kizumu-tahfiz-charity-visit': 'Kizumu Tahfiz Charity Visit',
                'tuition-for-brothers': 'Tuition for Brothers',
                'other': 'Other'
            };
            
            // Get payment method names
            const methodNames = {
                'mtn': 'MTN Mobile Money',
                'airtel': 'Airtel Money',
                'bank': 'Bank Transfer'
            };
            
            // Build WhatsApp message
            let message = `Assalam Alaikum Amir,\n\n`;
            message += `I would like to make a payment:\n\n`;
            message += `Payment Type: ${typeNames[paymentType] || paymentType}\n`;
            
            if (isSubscription && selectedPlan) {
                const planNames = {
                    'undergraduate': 'Undergraduate Plan',
                    'postgraduate': 'Postgraduate Plan',
                    'university-staff': 'University Staff Plan',
                    'elders': 'Elders Plan'
                };
                message += `Plan: ${planNames[selectedPlan] || selectedPlan}\n`;
                
                // Add subscription-specific fields
                const course = document.getElementById('course')?.value?.trim() || '';
                const faculty = document.getElementById('faculty')?.value?.trim() || '';
                if (course) message += `Course: ${course}\n`;
                if (faculty) message += `Faculty/Department: ${faculty}\n`;
            }
            
            if (name) message += `Name: ${name}\n`;
            if (regNumber) message += `Registration Number: ${regNumber}\n`;
            message += `Amount: ${parseInt(amount).toLocaleString()} UGX\n`;
            message += `Payment Method: ${methodNames[paymentMethod] || paymentMethod}\n`;
            
            if (paymentReason) {
                message += `Payment Reason: ${reasonNames[paymentReason] || paymentReason}\n`;
            }
            
            if (notes) {
                message += `Notes: ${notes}\n`;
            }
            
            message += `\nPlease confirm the payment details and provide further instructions.\n\nJazakallahu Khairan.`;
            
            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);
            
            // Open WhatsApp (mobile-friendly) - Use Amir's number: 256703268522
            if (typeof window.openWhatsApp === 'function') {
                window.openWhatsApp('256703268522', message);
            } else {
                // Fallback for older browsers
                const whatsappLink = `https://wa.me/256703268522?text=${encodedMessage}`;
                window.location.href = whatsappLink;
            }
            
            // Show success notice
            const notice = document.getElementById('amirDaawaNotice');
            if (notice) {
                notice.style.display = 'block';
                setTimeout(() => {
                    notice.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 500);
            }
        };

        // Handle payment method change
        function handlePaymentMethodChange() {
            const paymentMethod = document.getElementById('paymentMethod')?.value;
            const pesapalButton = document.getElementById('pesapalPaymentButton');
            const contactAmirBtn = document.getElementById('contactAmirBtn');
            const otherPaymentMethods = document.getElementById('otherPaymentMethods');
            
            // Show/hide other payment methods dropdown
            if (paymentMethod === 'other') {
                if (otherPaymentMethods) otherPaymentMethods.style.display = 'block';
                if (pesapalButton) pesapalButton.style.display = 'none';
                if (contactAmirBtn) contactAmirBtn.style.display = 'block';
            } else {
                if (otherPaymentMethods) otherPaymentMethods.style.display = 'none';
                
                if (paymentMethod === 'pesapal') {
                    // Show Pesapal button, hide WhatsApp button
                    if (pesapalButton) pesapalButton.style.display = 'block';
                    if (contactAmirBtn) contactAmirBtn.style.display = 'none';
                } else {
                    // Hide Pesapal button, show WhatsApp button
                    if (pesapalButton) pesapalButton.style.display = 'none';
                    if (contactAmirBtn) contactAmirBtn.style.display = 'block';
                }
            }
        }
        
        // Handle other payment method change
        function handleOtherPaymentMethodChange() {
            const otherMethod = document.getElementById('otherPaymentMethodSelect')?.value;
            const pesapalButton = document.getElementById('pesapalPaymentButton');
            const contactAmirBtn = document.getElementById('contactAmirBtn');
            
            // Update main payment method dropdown to reflect selection
            if (otherMethod === 'pesapal') {
                document.getElementById('paymentMethod').value = 'pesapal';
                if (pesapalButton) pesapalButton.style.display = 'block';
                if (contactAmirBtn) contactAmirBtn.style.display = 'none';
            } else {
                document.getElementById('paymentMethod').value = 'other';
                if (pesapalButton) pesapalButton.style.display = 'none';
                if (contactAmirBtn) contactAmirBtn.style.display = 'block';
            }
        }

        // Process Pesapal Payment
        async function processPesapalPayment() {
            try {
                // Validate form
                const paymentMethod = document.getElementById('paymentMethod')?.value;
                if (paymentMethod !== 'pesapal') {
                    showMobileAlert('Please select Pesapal as payment method', 'Payment Method Required');
                    return;
                }

                // Get payment details
                const amount = isSubscription ? selectedAmount : (document.getElementById('paymentAmount')?.value || '');
                if (!amount || amount <= 0) {
                    showMobileAlert('Please enter a valid amount', 'Invalid Amount');
                    document.getElementById('paymentAmount')?.focus();
                    return;
                }

                // Get payment description
                let description = '';
                if (selectedPaymentType === 'semester' || selectedPaymentType === 'monthly') {
                    const planNames = {
                        'undergraduate': 'Undergraduate Plan',
                        'postgraduate': 'Postgraduate Plan',
                        'university-staff': 'University Staff Plan',
                        'elders': 'Elders Plan'
                    };
                    description = `${planNames[selectedPlan] || selectedPlan} - ${selectedPaymentType === 'semester' ? 'Semester' : 'Monthly'} Subscription`;
                } else {
                    const typeNames = {
                        'zakat': 'Zakat Payment',
                        'charity': 'Charity Donation',
                        'donate': 'General Donation',
                        'kisilaahe': 'Kisilaahe Subscription'
                    };
                    description = typeNames[selectedPaymentType] || 'Payment';
                    
                    const reason = document.getElementById('paymentReason')?.value;
                    if (reason) {
                        const reasonNames = {
                            'general-donation': 'General Donation',
                            'iftar': 'Iftar',
                            'bananas': 'Bananas',
                            'mosque-building-fund': 'Mosque Building Fund',
                            'kizumu-tahfiz-charity-visit': 'Kizumu Tahfiz Charity Visit',
                            'tuition-for-brothers': 'Tuition for Brothers',
                            'other': 'Other'
                        };
                        description += ` - ${reasonNames[reason] || reason}`;
                    }
                }

                // Get user info (works with both Railway and Firebase)
                let userEmail = '';
                let firstName = '';
                let lastName = '';
                
                // Try to get from Firebase Auth if available
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    const user = firebase.auth().currentUser;
                    userEmail = user.email || '';
                    const userName = document.getElementById('paymentName')?.value || user.displayName || '';
                    const nameParts = userName.split(' ');
                    firstName = nameParts[0] || '';
                    lastName = nameParts.slice(1).join(' ') || '';
                } else {
                    // Fallback: get from form or prompt
                    userEmail = document.getElementById('paymentName')?.value || '';
                    if (!userEmail || !userEmail.includes('@')) {
                        // Prompt for email if not available
                        const emailInput = prompt('Please enter your email address for payment:');
                        if (!emailInput || !emailInput.includes('@')) {
                            showMobileAlert('A valid email address is required for Pesapal payments', 'Email Required');
                            return;
                        }
                        userEmail = emailInput;
                    }
                    const userName = document.getElementById('paymentName')?.value || '';
                    const nameParts = userName.split(' ');
                    firstName = nameParts[0] || '';
                    lastName = nameParts.slice(1).join(' ') || '';
                }

                // Show loading
                const payBtn = document.getElementById('payWithPesapalBtn');
                const originalText = payBtn.innerHTML;
                payBtn.disabled = true;
                payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                // Prepare payment data
                const paymentData = {
                    amount: parseFloat(amount),
                    currency: 'UGX',
                    description: description,
                    email: userEmail,
                    phone: '', // Can be added if you have phone field
                    first_name: firstName,
                    last_name: lastName,
                    callback_url: window.location.origin + '/payment/callback.html',
                    cancel_url: window.location.origin + '/payment/cancel.html'
                };

                // Initialize payment (this will redirect to Pesapal)
                // Works with both Railway and Firebase Functions
                if (typeof window.processPayment === 'function') {
                    await window.processPayment(paymentData);
                } else {
                    throw new Error('Pesapal payment system not loaded. Please refresh the page.');
                }

            } catch (error) {
                console.error('Pesapal payment error:', error);
                
                // Reset button
                const payBtn = document.getElementById('payWithPesapalBtn');
                if (payBtn) {
                    payBtn.disabled = false;
                    payBtn.innerHTML = '<i class="fas fa-credit-card"></i> Pay with Pesapal';
                }

                // Show error
                let errorMessage = 'Failed to process payment. Please try again.';
                if (error.message) {
                    errorMessage = error.message;
                }
                showMobileAlert(errorMessage, 'Payment Error');
            }
        }

        // Handle Zakat Form Submission
        document.addEventListener('DOMContentLoaded', function() {
            const zakatForm = document.getElementById('zakatCalculationForm');
            if (zakatForm) {
                zakatForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('zakatName').value.trim();
                    const contact = document.getElementById('zakatContact').value.trim();
                    const location = document.getElementById('zakatLocation').value.trim();
                    const business = document.getElementById('zakatBusiness').value.trim();
                    const date = document.getElementById('zakatDate').value;
                    const additionalInfo = document.getElementById('zakatAdditionalInfo').value.trim();
                    
                    // Validate required fields
                    if (!name || !contact || !location || !date) {
                        showMobileAlert('Please fill in all required fields', 'Required Fields Missing');
                        return;
                    }
                    
                    // Format WhatsApp message
                    let message = `*Zakat Calculation Request*\n\n`;
                    message += `*Name:* ${name}\n`;
                    message += `*Contact Number:* ${contact}\n`;
                    message += `*Location:* ${location}\n`;
                    if (business) {
                        message += `*Business:* ${business}\n`;
                    }
                    message += `*Date for Calculation:* ${date}\n`;
                    if (additionalInfo) {
                        message += `\n*Additional Information:*\n${additionalInfo}\n`;
                    }
                    message += `\n_Please calculate my Zakat obligation and contact me._`;
                    
                    // WhatsApp number: 0703268522 (256703268522)
                    const whatsappNumber = '256703268522';
                    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
                    
                    // Open WhatsApp
                    window.open(whatsappUrl, '_blank');
                    
                    // Show success message
                    document.getElementById('zakatSuccess').style.display = 'block';
                    zakatForm.reset();
                    
                    // Scroll to success message
                    setTimeout(() => {
                        document.getElementById('zakatSuccess').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                });
            }
            
            // Set default date to today
            const zakatDateInput = document.getElementById('zakatDate');
            if (zakatDateInput) {
                const today = new Date().toISOString().split('T')[0];
                zakatDateInput.value = today;
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const orderTrackingId = urlParams.get('OrderTrackingId');
            const orderMerchantReference = urlParams.get('OrderMerchantReference');
            
            // If we're on the callback page, handle it
            if (window.location.pathname.includes('callback') && orderTrackingId) {
                handlePesapalCallback({ OrderTrackingId: orderTrackingId, OrderMerchantReference: orderMerchantReference });
            }
        });

        // Handle Pesapal callback
        async function handlePesapalCallback(urlParams) {
            try {
                if (typeof window.handlePesapalCallback === 'function') {
                    const result = await window.handlePesapalCallback(urlParams);
                    
                    if (result.success) {
                        // Show success message
                        showMobileAlert(
                            `Payment successful!\n\nAmount: ${result.amount.toLocaleString()} ${result.currency}\nReference: ${result.reference}\n\nThank you for your payment!`,
                            'Payment Successful'
                        );
                        
                        // Redirect to payment page after 3 seconds
                        setTimeout(() => {
                            window.location.href = 'pay.html';
                        }, 3000);
                    } else {
                        throw new Error('Payment verification failed');
                    }
                } else {
                    console.warn('Pesapal callback handler not available');
                }
            } catch (error) {
                console.error('Callback handling error:', error);
                showMobileAlert(
                    'Payment verification failed. Please contact support if payment was deducted.',
                    'Verification Error'
                );
            }
        }
    </script>

    <!-- Floating Kizumu Visit Button -->
    <div class="floating-kizumu-btn" onclick="showActivitiesModal()">
        <i class="fas fa-heart"></i>
        <span>Kizumu Visit</span>
    </div>

    <!-- Activities Modal -->
    <div class="modal-overlay" id="activitiesModal" style="display: none;">
        <div class="modal-content activities-modal">
            <div class="modal-header">
                <h3><i class="fas fa-heart"></i> Important Activities</h3>
                <button class="modal-close" onclick="closeActivitiesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="activities-modal-list">
                <div class="activity-modal-item" onclick="navigateToActivity('kizumu-visit')">
                    <div class="activity-modal-icon" style="background: #E91E63;">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>Kizumu Tahfiz Charity Visit</h4>
                        <p>Support Islamic education through charity visit</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="activity-modal-item" onclick="navigateToActivity('tuition-brothers')">
                    <div class="activity-modal-icon" style="background: var(--primary-green);">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>Tuition for Brothers</h4>
                        <p>Support brothers' education and learning</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="activity-modal-item" onclick="navigateToActivity('kisilaahe')">
                    <div class="activity-modal-icon" style="background: #9C27B0;">
                        <i class="fas fa-donate"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>Donate to Kisilaahe</h4>
                        <p>Support Kisilaahe with essential items</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                
                <div class="activity-modal-item" onclick="navigateToActivity('activities')">
                    <div class="activity-modal-icon" style="background: #FF9800;">
                        <i class="fas fa-running"></i>
                    </div>
                    <div class="activity-modal-text">
                        <h4>View All Activities</h4>
                        <p>See all community activities and events</p>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Back function
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
